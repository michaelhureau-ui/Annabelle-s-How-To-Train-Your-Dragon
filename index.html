<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dragon World</title>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:Georgia,serif; background:#1a3a1a; min-height:100vh; color:white; }
.screen { display:none; }
.screen.active { display:block; }
.section-title { text-align:center; color:#ffd700; font-size:1.2em; margin-bottom:15px; }

#s-choose { background:linear-gradient(135deg,#0a0a2e,#1a1a4e,#0d2137); min-height:100vh; padding:20px; }
h1 { text-align:center; font-size:2em; color:#ffd700; text-shadow:0 0 20px #ff6600; margin-bottom:5px; }
.subtitle { text-align:center; color:#aad4ff; margin-bottom:20px; }
.dragon-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; max-width:680px; margin:0 auto 20px; }
.dragon-card { background:rgba(255,255,255,0.08); border:2px solid rgba(255,255,255,0.2); border-radius:15px; padding:12px; text-align:center; cursor:pointer; transition:all 0.3s; }
.dragon-card:hover,.dragon-card.selected { border-color:#ffd700; background:rgba(255,215,0,0.2); transform:scale(1.05); }
.d-emoji { font-size:2.5em; }
.d-name { font-weight:bold; color:#ffd700; margin:4px 0 2px; font-size:0.9em; }
.d-type { font-size:0.7em; color:#aad4ff; }
.cbox { background:rgba(255,255,255,0.08); border-radius:20px; padding:20px; max-width:460px; margin:0 auto; }
.cbox label { display:block; margin:10px 0 4px; color:#ffd700; font-weight:bold; }
.cbox input { width:100%; padding:9px; border-radius:10px; border:2px solid rgba(255,215,0,0.4); background:rgba(0,0,0,0.3); color:white; font-size:1em; }
.color-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:5px; }
.cbtn { width:32px; height:32px; border-radius:50%; border:3px solid transparent; cursor:pointer; transition:transform 0.2s; }
.cbtn.selected { border-color:white; transform:scale(1.2); }
.power-row { display:flex; gap:7px; flex-wrap:wrap; margin-top:5px; }
.pbtn { padding:6px 12px; border-radius:20px; border:2px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:white; cursor:pointer; font-size:0.8em; }
.pbtn.selected { background:rgba(255,215,0,0.3); border-color:#ffd700; color:#ffd700; }
.big-btn { display:block; margin:15px auto 0; padding:13px 30px; border-radius:15px; border:none; background:linear-gradient(135deg,#ffd700,#ff8c00); color:#1a1a1a; font-size:1.05em; font-weight:bold; cursor:pointer; }
.big-btn:hover { transform:scale(1.05); }
.back-btn { display:block; margin:10px auto 0; padding:8px 20px; border-radius:15px; border:2px solid rgba(255,255,255,0.3); background:transparent; color:white; font-size:0.9em; cursor:pointer; }

#s-world { min-height:100vh; }
.biome { position:relative; min-height:100vh; background:linear-gradient(180deg,#87CEEB 0%,#87CEEB 35%,#4a7c3f 35%,#4a7c3f 38%,#2d5a1b 38%); overflow:hidden; }
.cloud { position:absolute; background:white; border-radius:50px; opacity:0.85; animation:drift linear infinite; }
@keyframes drift { from{transform:translateX(-200px)} to{transform:translateX(110vw)} }
.grass-area { position:absolute; top:35%; left:0; right:0; bottom:0; background:linear-gradient(180deg,#4a7c3f,#2d5a1b 60%,#1a3a0a); }
.blade { position:absolute; width:6px; border-radius:3px 3px 0 0; background:linear-gradient(#6ab04c,#2d5a1b); bottom:0; }

.hud { position:absolute; top:10px; left:10px; right:10px; z-index:10; display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px; }
.hud-card { background:rgba(0,0,0,0.6); border:1px solid rgba(255,215,0,0.4); border-radius:12px; padding:8px 12px; min-width:130px; }
.hud-name { color:#ffd700; font-weight:bold; font-size:0.9em; }
.stat-row { display:flex; align-items:center; gap:6px; margin-top:4px; }
.stat-label { font-size:0.72em; color:#aad4ff; width:55px; }
.stat-bar { flex:1; height:10px; background:rgba(255,255,255,0.2); border-radius:5px; overflow:hidden; }
.stat-fill { height:100%; border-radius:5px; transition:width 0.5s; }
.fill-food { background:linear-gradient(90deg,#ff6b35,#ffd700); }
.fill-water { background:linear-gradient(90deg,#4fc3f7,#0288d1); }
.fill-happy { background:linear-gradient(90deg,#f06292,#e91e63); }
.fill-coins { background:linear-gradient(90deg,#ffd700,#ff8c00); }

.location { position:absolute; cursor:pointer; text-align:center; transition:transform 0.2s; z-index:5; }
.location:hover { transform:scale(1.1); }
.loc-icon { font-size:2.5em; display:block; filter:drop-shadow(0 3px 6px rgba(0,0,0,0.5)); }
.loc-label { font-size:0.7em; font-weight:bold; color:white; text-shadow:0 1px 4px black; background:rgba(0,0,0,0.5); border-radius:8px; padding:2px 6px; margin-top:2px; display:block; }

#world-dragon { position:absolute; font-size:4em; z-index:8; transition:all 1s ease; filter:drop-shadow(0 5px 10px rgba(0,0,0,0.6)); animation:bob 2s ease-in-out infinite; }
@keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

.floating-coin { position:absolute; font-size:1.8em; cursor:pointer; z-index:6; filter:drop-shadow(0 0 8px #ffd700); user-select:none; animation:coinbob 1.5s ease-in-out infinite; }
.floating-coin:hover { transform:scale(1.4); }
@keyframes coinbob { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-8px) scale(1.1)} }
.coin-flash { position:fixed; top:45%; left:50%; transform:translateX(-50%); font-size:1.5em; color:#ffd700; font-weight:bold; z-index:999; pointer-events:none; animation:flashup 1s ease forwards; }
@keyframes flashup { 0%{opacity:1;top:45%} 100%{opacity:0;top:30%} }

.action-panel { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.8); padding:12px; z-index:10; border-top:2px solid rgba(255,215,0,0.3); }
.action-row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
.abtn { padding:10px 14px; border-radius:12px; border:none; font-size:0.82em; font-weight:bold; cursor:pointer; color:white; transition:all 0.2s; }
.abtn:hover { transform:scale(1.06); }
.btn-feed { background:linear-gradient(135deg,#e67e22,#d35400); }
.btn-water { background:linear-gradient(135deg,#2980b9,#1a5276); }
.btn-quest { background:linear-gradient(135deg,#8e44ad,#6c3483); }
.btn-rescue { background:linear-gradient(135deg,#c0392b,#922b21); }
.btn-battle { background:linear-gradient(135deg,#d35400,#a04000); }
.btn-fly { background:linear-gradient(135deg,#27ae60,#1e8449); }
.btn-game { background:linear-gradient(135deg,#16a085,#1abc9c); }
.btn-shop { background:linear-gradient(135deg,#f39c12,#d68910); }

.popup-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.75); z-index:100; display:none; align-items:center; justify-content:center; padding:20px; }
.popup-overlay.open { display:flex; }
.popup { background:linear-gradient(135deg,#1a2a1a,#0d1a0d); border:2px solid rgba(255,215,0,0.5); border-radius:20px; padding:25px; max-width:520px; width:100%; max-height:85vh; overflow-y:auto; text-align:center; }
.popup-title { font-size:1.3em; color:#ffd700; margin-bottom:12px; }
.popup-text { line-height:1.7; color:#e0e0e0; margin-bottom:12px; }
.outcome { font-size:1.1em; font-weight:bold; margin-top:10px; }
.win { color:#2ecc71; } .lose { color:#e74c3c; }
.close-btn { padding:10px 25px; border-radius:12px; border:none; background:linear-gradient(135deg,#ffd700,#ff8c00); color:#1a1a1a; font-weight:bold; cursor:pointer; margin-top:12px; }

.game-choice { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:10px; }
.game-choice-btn { padding:11px 16px; border-radius:15px; border:2px solid rgba(255,215,0,0.4); background:rgba(255,215,0,0.1); color:#ffd700; font-size:0.95em; cursor:pointer; }
.game-choice-btn:hover { background:rgba(255,215,0,0.25); transform:scale(1.05); }

.ttt-board { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; max-width:240px; margin:10px auto; }
.ttt-cell { height:70px; background:rgba(255,255,255,0.1); border:2px solid rgba(255,215,0,0.3); border-radius:10px; font-size:2.2em; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.ttt-cell:hover { background:rgba(255,215,0,0.15); }

.card-area { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:10px 0; }
.card { width:65px; height:95px; border-radius:10px; border:2px solid #ffd700; background:linear-gradient(135deg,#1a3a6e,#0d2137); font-size:2em; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.2s; }
.card:hover { transform:scale(1.1) translateY(-5px); }
.card.flipped { background:linear-gradient(135deg,#2d5a1b,#1a3a0a); }

.aim-row { display:flex; gap:10px; justify-content:center; margin:10px 0; }
.aim-btn { padding:8px 16px; border-radius:10px; border:2px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:white; cursor:pointer; }
.aim-btn:hover { background:rgba(255,215,0,0.2); border-color:#ffd700; }
.goal { width:120px; height:70px; border:4px solid white; border-bottom:none; margin:0 auto 10px; border-radius:5px 5px 0 0; position:relative; background:rgba(255,255,255,0.05); }

.shop-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; margin:10px 0; }
.shop-item { background:rgba(255,255,255,0.08); border:2px solid rgba(255,215,0,0.3); border-radius:15px; padding:12px; text-align:center; cursor:pointer; transition:all 0.2s; }
.shop-item:hover { border-color:#ffd700; background:rgba(255,215,0,0.15); transform:scale(1.04); }
.shop-item.owned { border-color:#2ecc71; background:rgba(46,204,113,0.12); cursor:default; }
.shop-item.owned:hover { transform:none; }
.shop-emoji { font-size:2em; margin-bottom:4px; }
.shop-name { font-weight:bold; color:#ffd700; font-size:0.83em; }
.shop-price { color:#aad4ff; font-size:0.76em; margin-top:3px; }
.owned-tag { color:#2ecc71; font-size:0.75em; font-weight:bold; }
.coin-display { color:#ffd700; font-size:1.1em; font-weight:bold; margin-bottom:12px; }
</style>

</head>
<body>

<!-- SCREEN 1: Choose Dragon -->

<div id="s-choose" class="screen active">
  <h1>üêâ Dragon World</h1>
  <p class="subtitle">How to Train Your Dragon</p>
  <p class="section-title">Choose Your Dragon!</p>
  <div class="dragon-grid">
    <div class="dragon-card" onclick="pick(this,'Toothless','Night Fury','üêâ')"><div class="d-emoji">üêâ</div><div class="d-name">Toothless</div><div class="d-type">Night Fury</div></div>
    <div class="dragon-card" onclick="pick(this,'Light Fury','Light Fury','ü§ç')"><div class="d-emoji">ü§ç</div><div class="d-name">Light Fury</div><div class="d-type">Light Fury</div></div>
    <div class="dragon-card" onclick="pick(this,'Stormfly','Deadly Nadder','üíô')"><div class="d-emoji">üíô</div><div class="d-name">Stormfly</div><div class="d-type">Deadly Nadder</div></div>
    <div class="dragon-card" onclick="pick(this,'Hookfang','Monstrous Nightmare','üî•')"><div class="d-emoji">üî•</div><div class="d-name">Hookfang</div><div class="d-type">Monstrous Nightmare</div></div>
    <div class="dragon-card" onclick="pick(this,'Meatlug','Gronckle','ü™®')"><div class="d-emoji">ü™®</div><div class="d-name">Meatlug</div><div class="d-type">Gronckle</div></div>
    <div class="dragon-card" onclick="pick(this,'Barf and Belch','Hideous Zippleback','üíö')"><div class="d-emoji">üíö</div><div class="d-name">Barf &amp; Belch</div><div class="d-type">Hideous Zippleback</div></div>
    <div class="dragon-card" onclick="pick(this,'Cloudjumper','Stormcutter','‚ö°')"><div class="d-emoji">‚ö°</div><div class="d-name">Cloudjumper</div><div class="d-type">Stormcutter</div></div>
    <div class="dragon-card" onclick="pick(this,'Skullcrusher','Rumblehorn','üíú')"><div class="d-emoji">üíú</div><div class="d-name">Skullcrusher</div><div class="d-type">Rumblehorn</div></div>
  </div>
  <p class="section-title">Customize!</p>
  <div class="cbox">
    <label>Give your dragon a nickname:</label>
    <input type="text" id="nickname" placeholder="e.g. Sparkles, Blaze, Shadow...">
    <label>Choose a color:</label>
    <div class="color-row">
      <div class="cbtn selected" style="background:#111" onclick="pickColor(this,'Midnight Black')"></div>
      <div class="cbtn" style="background:#e74c3c" onclick="pickColor(this,'Fire Red')"></div>
      <div class="cbtn" style="background:#3498db" onclick="pickColor(this,'Ocean Blue')"></div>
      <div class="cbtn" style="background:#2ecc71" onclick="pickColor(this,'Forest Green')"></div>
      <div class="cbtn" style="background:#9b59b6" onclick="pickColor(this,'Royal Purple')"></div>
      <div class="cbtn" style="background:#ffd700" onclick="pickColor(this,'Golden Yellow')"></div>
      <div class="cbtn" style="background:#fff" onclick="pickColor(this,'Pearly White')"></div>
      <div class="cbtn" style="background:#ff69b4" onclick="pickColor(this,'Hot Pink')"></div>
    </div>
    <label>Choose a special power:</label>
    <div class="power-row">
      <button class="pbtn selected" onclick="pickPower(this,'Plasma Blast')">üî• Plasma Blast</button>
      <button class="pbtn" onclick="pickPower(this,'Lightning Strike')">‚ö° Lightning Strike</button>
      <button class="pbtn" onclick="pickPower(this,'Ice Breath')">‚ùÑÔ∏è Ice Breath</button>
      <button class="pbtn" onclick="pickPower(this,'Tornado Spin')">üí® Tornado Spin</button>
      <button class="pbtn" onclick="pickPower(this,'Magic Shield')">‚ú® Magic Shield</button>
    </div>
  </div>
  <button class="big-btn" onclick="startWorld()">Enter Dragon World! üåç</button>
</div>

<!-- SCREEN 2: World -->

<div id="s-world" class="screen">
  <div class="biome" id="biome">
    <div class="cloud" style="width:120px;height:40px;top:5%;animation-duration:30s;animation-delay:0s"></div>
    <div class="cloud" style="width:80px;height:28px;top:10%;animation-duration:22s;animation-delay:-8s"></div>
    <div class="cloud" style="width:100px;height:35px;top:14%;animation-duration:26s;animation-delay:-15s"></div>
    <div class="cloud" style="width:60px;height:22px;top:8%;animation-duration:18s;animation-delay:-5s"></div>
    <div class="grass-area" id="grass-area"></div>
    <div style="position:absolute;top:4%;right:8%;font-size:3em;z-index:4">‚òÄÔ∏è</div>

```
<!-- HUD -->
<div class="hud">
  <div class="hud-card">
    <div class="hud-name" id="hud-name">Dragon</div>
    <div style="font-size:0.7em;color:#aad4ff" id="hud-type">Night Fury</div>
  </div>
  <div class="hud-card" style="min-width:170px">
    <div class="stat-row"><span class="stat-label">üçñ Food</span><div class="stat-bar"><div class="stat-fill fill-food" id="bar-food" style="width:70%"></div></div></div>
    <div class="stat-row"><span class="stat-label">üíß Water</span><div class="stat-bar"><div class="stat-fill fill-water" id="bar-water" style="width:70%"></div></div></div>
    <div class="stat-row"><span class="stat-label">üòÑ Happy</span><div class="stat-bar"><div class="stat-fill fill-happy" id="bar-happy" style="width:70%"></div></div></div>
    <div class="stat-row"><span class="stat-label">ü™ô Coins</span><div class="stat-bar"><div class="stat-fill fill-coins" id="bar-coins" style="width:0%"></div></div><span id="coin-count" style="font-size:0.72em;color:#ffd700;margin-left:5px">0</span></div>
  </div>
</div>

<!-- Dragon -->
<div id="world-dragon" style="bottom:22%;left:42%">üêâ</div>

<!-- Locations -->
<div class="location" style="bottom:52%;left:5%" onclick="visitLoc('village')">
  <span class="loc-icon">üèòÔ∏è</span><span class="loc-label">Village</span>
</div>
<div class="location" style="bottom:40%;left:18%" onclick="feedDragon()">
  <span class="loc-icon">üêü</span><span class="loc-label">Fish Stand</span>
</div>
<div class="location" style="bottom:40%;right:18%" onclick="waterDragon()">
  <span class="loc-icon">üíß</span><span class="loc-label">Watering Hole</span>
</div>
<div class="location" style="bottom:52%;right:5%" onclick="visitLoc('arena')">
  <span class="loc-icon">‚öîÔ∏è</span><span class="loc-label">Arena</span>
</div>
<div class="location" style="bottom:55%;left:35%" onclick="openShop()">
  <span class="loc-icon">üî®</span><span class="loc-label">Blacksmith</span>
</div>
<div class="location" style="bottom:36%;left:47%" onclick="visitLoc('meadow')">
  <span class="loc-icon">üå∏</span><span class="loc-label">Meadow</span>
</div>

<!-- Action Panel -->
<div class="action-panel">
  <div class="action-row">
    <button class="abtn btn-feed" onclick="feedDragon()">üêü Feed Dragon</button>
    <button class="abtn btn-water" onclick="waterDragon()">üíß Give Water</button>
    <button class="abtn btn-quest" onclick="doAction('quest')">üó∫Ô∏è Quest</button>
    <button class="abtn btn-rescue" onclick="doAction('rescue')">üÜò Rescue</button>
    <button class="abtn btn-battle" onclick="doAction('battle')">‚öîÔ∏è Battle</button>
    <button class="abtn btn-fly" onclick="doAction('fly')">üå§Ô∏è Fly Tricks</button>
    <button class="abtn btn-game" onclick="openGameMenu()">üéÆ Play a Game</button>
    <button class="abtn btn-shop" onclick="openShop()">üî® Blacksmith</button>
  </div>
</div>
```

  </div>
</div>

<!-- POPUP -->

<div class="popup-overlay" id="popup">
  <div class="popup">
    <div class="popup-title" id="popup-title"></div>
    <div id="popup-body"></div>
    <button class="close-btn" onclick="closePopup()">Close ‚úï</button>
  </div>
</div>

<script>
// ---- STATE ----
var d = {name:'Toothless', type:'Night Fury', emoji:'üêâ', nickname:'', color:'Midnight Black', power:'Plasma Blast'};
var stats = {food:70, water:70, happy:70};
var coins = 0;
var MAX_COINS = 100;
var ownedSaddles = [];

var saddles = [
  {id:'basic',  emoji:'üü§', name:'Basic Saddle',   price:5,  desc:'A sturdy saddle for new riders!'},
  {id:'royal',  emoji:'üëë', name:'Royal Saddle',   price:15, desc:'Fit for a Viking champion!'},
  {id:'fire',   emoji:'üî•', name:'Fire Saddle',    price:20, desc:'Heat-resistant and blazing fast!'},
  {id:'shadow', emoji:'üåë', name:'Shadow Saddle',  price:25, desc:'Blends into the night!'},
  {id:'ice',    emoji:'‚ùÑÔ∏è', name:'Ice Saddle',     price:30, desc:'Cool and sleek for icy adventures!'},
  {id:'golden', emoji:'‚ú®', name:'Golden Saddle',  price:40, desc:'The rarest saddle in all of Berk!'}
];

// ---- SETUP ----
function go(id) {
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}
function pick(el, name, type, emoji) {
  document.querySelectorAll('.dragon-card').forEach(function(c){c.classList.remove('selected');});
  el.classList.add('selected');
  d.name = name; d.type = type; d.emoji = emoji;
}
function pickColor(el, color) {
  document.querySelectorAll('.cbtn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected'); d.color = color;
}
function pickPower(el, power) {
  document.querySelectorAll('.pbtn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected'); d.power = power;
}
function getN() { return d.nickname || d.name; }

function startWorld() {
  d.nickname = document.getElementById('nickname').value || d.name;
  document.getElementById('hud-name').textContent = d.nickname;
  document.getElementById('hud-type').textContent = d.color + ' ' + d.type;
  document.getElementById('world-dragon').textContent = d.emoji;
  buildGrass();
  go('s-world');
  spawnCoins();
  setInterval(spawnCoins, 10000);
  setInterval(function(){ changeStat('food',-1); changeStat('water',-1); }, 15000);
}

function buildGrass() {
  var g = document.getElementById('grass-area');
  for(var i=0;i<60;i++){
    var b = document.createElement('div');
    b.className = 'blade';
    var h = 20 + Math.random()*30;
    b.style.cssText = 'left:'+Math.random()*100+'%;height:'+h+'px;opacity:'+(0.5+Math.random()*0.5)+';transform:rotate('+(Math.random()*20-10)+'deg)';
    g.appendChild(b);
  }
}

// ---- STATS ----
function changeStat(stat, amount) {
  stats[stat] = Math.max(0, Math.min(100, stats[stat] + amount));
  document.getElementById('bar-' + stat).style.width = stats[stat] + '%';
  if(stat === 'food' || stat === 'water') {
    stats.happy = Math.max(0, Math.min(100, (stats.food + stats.water) / 2));
    document.getElementById('bar-happy').style.width = stats.happy + '%';
  }
}

// ---- COINS ----
function spawnCoins() {
  document.querySelectorAll('.floating-coin').forEach(function(c){c.remove();});
  var biome = document.getElementById('biome');
  for(var i=0;i<6;i++){
    var coin = document.createElement('div');
    coin.className = 'floating-coin';
    coin.textContent = 'ü™ô';
    var left = 3 + Math.random() * 50;
    var bottom = 36 + Math.random() * 25;
    coin.style.cssText = 'left:'+left+'%;bottom:'+bottom+'%;animation-delay:'+(Math.random()*1.5)+'s';
    (function(c){ c.onclick = function(){ collectCoin(c); }; })(coin);
    biome.appendChild(coin);
  }
}

function collectCoin(el) {
  el.remove();
  if(coins >= MAX_COINS) return;
  coins++;
  updateCoins();
  var flash = document.createElement('div');
  flash.className = 'coin-flash';
  flash.textContent = '+1 ü™ô';
  document.body.appendChild(flash);
  setTimeout(function(){ flash.remove(); }, 1000);
}

function updateCoins() {
  document.getElementById('bar-coins').style.width = (coins / MAX_COINS * 100) + '%';
  document.getElementById('coin-count').textContent = coins;
}

// ---- FEED / WATER ----
function feedDragon() {
  if(stats.food >= 100){ showPopup('üêü Already Full!', getN() + ' is stuffed! Come back when they are hungry again.', ''); return; }
  changeStat('food', 25);
  showPopup('üêü Fish Stand!', 'You grabbed a big bucket of fresh fish! ' + getN() + ' gobbled them up and roared happily!', '<div class="outcome win">+25 Food! Nom nom nom!</div>');
}

function waterDragon() {
  if(stats.water >= 100){ showPopup('üíß Not Thirsty!', getN() + ' just had a big drink. They are not thirsty yet!', ''); return; }
  changeStat('water', 25);
  showPopup('üíß Watering Hole!', getN() + ' dipped their head into the sparkling watering hole and took a long, refreshing drink!', '<div class="outcome win">+25 Water! Splish splash!</div>');
}

// ---- LOCATIONS ----
var locData = {
  village: {t:'üèòÔ∏è The Village!', txt:'You soar over the village of Berk! Vikings wave from below, kids cheer as your dragon swoops overhead, and the blacksmith gives a big thumbs up!'},
  arena:   {t:'‚öîÔ∏è The Arena!',   txt:'The training arena is huge with wooden targets, obstacle courses, and rings of fire. Your dragon crouches low and lets out a battle roar, ready to train!'},
  meadow:  {t:'üå∏ The Meadow!',  txt:'A wide meadow full of wildflowers and butterflies! Your dragon rolls around in the grass and sneezes out a tiny puff of fire. So cute!'}
};
function visitLoc(key) {
  var l = locData[key];
  showPopup(l.t, l.txt, '');
}

// ---- ADVENTURES ----
var quests = [
  {t:'üó∫Ô∏è The Lost Map',      txt:'A mysterious map appeared showing a hidden island full of treasure! Fly through a fierce storm and past giant sea stacks to reach it!'},
  {t:'üèîÔ∏è The Frozen Mountain', txt:'Villagers are trapped on the mountain in a blizzard! Fly through icy winds and dodge falling rocks to guide them safely home.'},
  {t:'ü•ö The Stolen Egg',    txt:'Thieves stole a rare dragon egg! Chase them across three islands and outsmart their traps to return it to safety!'}
];
var rescues = [
  {t:'ü¶á Trapped in a Cave!', txt:'A young Gronckle is stuck in a collapsing cave! Squeeze through dark tunnels, calm the frightened dragon, and carry it out to safety!'},
  {t:'üï∏Ô∏è Caught in a Net!',  txt:'A Deadly Nadder is tangled in a giant fishing net near a cliff! Carefully burn through the ropes without hurting it!'},
  {t:'üê£ Lost Hatchlings!',  txt:'Three baby dragons wandered away from their nest and are hiding all over the island! Find them all before nightfall!'}
];
var battles = [
  {t:'üî¥ The Red Death!',      txt:'A massive Red Death appeared off the coast! Dodge its fire blasts and find its weak spot to drive it back into the sea!'},
  {t:'üèÜ Rival Dragon Rider!', txt:'A rival Viking clan challenged you to a dragon battle in the arena! Prove you and your dragon are the best on Berk!'},
  {t:'üåô Night Wing Attack!',  txt:'A pack of wild Night Wings is swooping toward Berk! Lead them away with your dragon\'s special power!'}
];
var flyTricks = [
  {t:'üåÄ The Spiral Dive!', txt:'You launch into the sky and pull into a tight corkscrew spin, then SNAP your wings open and soar back up! The crowd goes wild!'},
  {t:'‚òÅÔ∏è The Cloud Surf!',  txt:'You glide across the top of a fluffy cloud, dipping one wing in and out of the mist, then burst into bright sunshine above!'},
  {t:'üî• The Fire Trail!',  txt:'You blast your power in a huge arc while doing a figure-eight. The crowd has never seen anything like it!'}
];

function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function doAction(type) {
  var item;
  if(type==='quest') item = rand(quests);
  else if(type==='rescue') item = rand(rescues);
  else if(type==='battle') item = rand(battles);
  else item = rand(flyTricks);
  var win = Math.random() > 0.35;
  var msgs = {
    quest:  {w:'üéâ You and '+getN()+' completed the quest! Berk celebrates you as a hero!',    l:'üò¨ Tricky this time, but '+getN()+' knows you will try again!'},
    rescue: {w:'ü•≥ You saved the dragon! It nuzzles you with its nose as a thank you!',          l:'üò∞ Hard rescue, but '+getN()+' kept you safe!'},
    battle: {w:'üèÜ Victory! You showed everyone what true dragon riders can do!',                l:'üí™ Tough fight! You learned new moves for next time!'},
    fly:    {w:'‚≠ê Perfect score! The crowd goes wild for '+getN()+'s tricks!',                  l:'üòÑ Fun run! '+getN()+' wants to practice more!'}
  };
  if(win) { changeStat('happy', 10); coins = Math.min(MAX_COINS, coins + 2); updateCoins(); }
  showPopup(item.t, item.txt, '<div class="outcome '+(win?'win':'lose')+'">'+(win?msgs[type].w:msgs[type].l)+'</div>');
}

// ---- BLACKSMITH SHOP ----
function openShop() {
  var html = '<div class="coin-display">You have ' + coins + ' ü™ô coins</div><div class="shop-grid">';
  for(var i=0;i<saddles.length;i++){
    var s = saddles[i];
    var owned = ownedSaddles.indexOf(s.id) !== -1;
    html += '<div class="shop-item' + (owned ? ' owned' : '') + '"';
    if(!owned) html += ' onclick="buySaddle(\'' + s.id + '\',\'' + s.name + '\',' + s.price + ')"';
    html += '>';
    html += '<div class="shop-emoji">' + s.emoji + '</div>';
    html += '<div class="shop-name">' + s.name + '</div>';
    html += '<div class="shop-price">' + (owned ? '<span class="owned-tag">‚úÖ Owned!</span>' : 'ü™ô ' + s.price + ' coins') + '</div>';
    html += '<div style="font-size:0.72em;color:#aad4ff;margin-top:3px">' + s.desc + '</div>';
    html += '</div>';
  }
  html += '</div>';
  showPopup('üî® Blacksmith Shop', '', html);
}

function buySaddle(id, name, price) {
  if(coins < price) {
    var flash = document.createElement('div');
    flash.className = 'coin-flash';
    flash.style.color = '#e74c3c';
    flash.textContent = 'Not enough coins!';
    document.body.appendChild(flash);
    setTimeout(function(){ flash.remove(); }, 1200);
    return;
  }
  coins -= price;
  ownedSaddles.push(id);
  updateCoins();
  showPopup('üéâ New Saddle!', 'You bought the ' + name + '! ' + getN() + ' looks amazing in it! Collect more coins to get the next one!', '<div class="outcome win">Purchase complete! üõí</div>');
}

// ---- GAMES ----
function openGameMenu() {
  showPopup('üéÆ Play a Game!', 'Which game do you want to play with ' + getN() + '?',
    '<div class="game-choice">' +
    '<button class="game-choice-btn" onclick="startTTT()">‚≠ï Tic Tac Toe</button>' +
    '<button class="game-choice-btn" onclick="startCards()">üÉè Card Match</button>' +
    '<button class="game-choice-btn" onclick="startSoccer()">‚öΩ Dragon Soccer</button>' +
    '</div>');
}

// TTT
var tttB, tttTurn, tttOn;
function startTTT() {
  tttB = ['','','','','','','','','']; tttTurn = 'X'; tttOn = true;
  drawTTT();
}
function drawTTT() {
  var cells = '';
  for(var i=0;i<9;i++){
    var v = tttB[i];
    cells += '<div class="ttt-cell" onclick="tttClick('+i+')">'+( v==='X'?'üî•' : v==='O'?d.emoji : '')+'</div>';
  }
  document.getElementById('popup-body').innerHTML =
    '<p style="color:#aad4ff;margin-bottom:8px">' + (tttOn ? (tttTurn==='X'?'Your turn üî•':''+getN()+'\'s turn '+d.emoji) : 'Game Over!') + '</p>' +
    '<div class="ttt-board">'+cells+'</div>' +
    '<button class="game-choice-btn" style="margin-top:10px" onclick="startTTT()">New Game</button>' +
    '<button class="game-choice-btn" style="margin-top:10px" onclick="openGameMenu()">‚Üê Back</button>';
}
function tttClick(i) {
  if(!tttOn || tttB[i]) return;
  tttB[i] = tttTurn;
  var w = checkTTT();
  if(w){ tttOn=false; drawTTT(); addTTTResult(w); return; }
  if(tttB.indexOf('') === -1){ tttOn=false; drawTTT(); addTTTResult('draw'); return; }
  tttTurn = tttTurn==='X'?'O':'X';
  drawTTT();
  if(tttTurn==='O') setTimeout(aiTTT, 600);
}
function aiTTT() {
  if(!tttOn) return;
  var empty = [];
  for(var i=0;i<9;i++){ if(!tttB[i]) empty.push(i); }
  if(!empty.length) return;
  tttB[empty[Math.floor(Math.random()*empty.length)]] = 'O';
  var w = checkTTT();
  if(w){ tttOn=false; drawTTT(); addTTTResult(w); return; }
  if(tttB.indexOf('') === -1){ tttOn=false; drawTTT(); addTTTResult('draw'); return; }
  tttTurn = 'X'; drawTTT();
}
function checkTTT() {
  var lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(var i=0;i<lines.length;i++){
    var a=lines[i][0], b=lines[i][1], c=lines[i][2];
    if(tttB[a] && tttB[a]===tttB[b] && tttB[a]===tttB[c]) return tttB[a];
  }
  return null;
}
function addTTTResult(w) {
  var msg = w==='draw' ? 'Draw! '+getN()+' roars respectfully!' :
            w==='X'    ? 'üéâ You win! '+getN()+' does a happy flip!' :
                         getN()+' wins! The dragon roars triumphantly! üî•';
  document.getElementById('popup-body').innerHTML += '<div class="outcome '+(w==='X'?'win':w==='draw'?'':'lose')+'" style="margin-top:8px">'+msg+'</div>';
}

// CARD MATCH
var cCards, cFlipped, cMatched, cCanFlip;
var cSymbols = ['üêâ','‚ö°','üî•','‚ùÑÔ∏è','üí®','‚ú®'];
function startCards() {
  var deck = cSymbols.concat(cSymbols).sort(function(){return Math.random()-0.5;});
  cCards = deck.map(function(s,i){return {id:i,s:s,shown:false,matched:false};});
  cFlipped=[]; cMatched=0; cCanFlip=true;
  drawCards();
}
function drawCards() {
  var html = '<p style="color:#aad4ff;margin-bottom:8px">Match all pairs! '+cMatched+'/'+cSymbols.length+' matched</p><div class="card-area">';
  for(var i=0;i<cCards.length;i++){
    var c = cCards[i];
    html += '<div class="card'+(c.shown||c.matched?' flipped':'')+'" onclick="flipCard('+i+')">'+(c.shown||c.matched?c.s:'üê≤')+'</div>';
  }
  html += '</div>';
  html += '<button class="game-choice-btn" style="margin-top:10px" onclick="startCards()">New Game</button>';
  html += '<button class="game-choice-btn" style="margin-top:10px" onclick="openGameMenu()">‚Üê Back</button>';
  document.getElementById('popup-body').innerHTML = html;
}
function flipCard(i) {
  if(!cCanFlip || cCards[i].shown || cCards[i].matched) return;
  cCards[i].shown = true; cFlipped.push(i); drawCards();
  if(cFlipped.length === 2) {
    cCanFlip = false;
    setTimeout(function(){
      var a=cFlipped[0], b=cFlipped[1];
      if(cCards[a].s === cCards[b].s){ cCards[a].matched=cCards[b].matched=true; cMatched++; }
      cCards[a].shown=cCards[b].shown=false; cFlipped=[]; cCanFlip=true;
      drawCards();
      if(cMatched===cSymbols.length) document.getElementById('popup-body').innerHTML += '<div class="outcome win" style="margin-top:8px">üéâ You matched them all! '+getN()+' is so proud!</div>';
    }, 800);
  }
}

// SOCCER
var sScore, sGoals, sOn;
function startSoccer() {
  sScore=0; sGoals=0; sOn=true;
  drawSoccer('');
}
function drawSoccer(msg) {
  document.getElementById('popup-body').innerHTML =
    '<p style="color:#ffd700;margin-bottom:6px">‚öΩ Dragon Soccer! Score 3 goals to win!</p>' +
    '<p style="color:#aad4ff;font-size:0.85em;margin-bottom:8px">Shots: '+sScore+' | Goals: '+sGoals+'/3</p>' +
    '<div class="goal"><div id="gfb" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2em"></div></div>' +
    '<p style="color:#aad4ff;font-size:0.85em;margin:8px 0">Pick your shot:</p>' +
    '<div class="aim-row">' +
    '<button class="aim-btn" onclick="shoot(\'left\')">‚ÜñÔ∏è Left</button>' +
    '<button class="aim-btn" onclick="shoot(\'center\')">‚¨ÜÔ∏è Center</button>' +
    '<button class="aim-btn" onclick="shoot(\'right\')">‚ÜóÔ∏è Right</button>' +
    '</div>' +
    (msg ? '<p style="margin-top:8px;font-weight:bold;color:'+( msg.indexOf('GOAL')!==-1?'#2ecc71':'#e74c3c')+'">'+msg+'</p>' : '') +
    '<button class="game-choice-btn" style="margin-top:10px" onclick="startSoccer()">New Game</button>' +
    '<button class="game-choice-btn" style="margin-top:10px" onclick="openGameMenu()">‚Üê Back</button>';
}
function shoot(dir) {
  if(!sOn) return;
  sScore++;
  var dirs = ['left','center','right'];
  var goalie = dirs[Math.floor(Math.random()*3)];
  var scored = dir !== goalie;
  if(scored) sGoals++;
  var fb = document.getElementById('gfb');
  if(fb) fb.textContent = scored ? '‚öΩ' : 'üß§';
  var msg = scored ? 'GOAL! ' + getN() + ' breathes fire in celebration! üî•' : 'Saved! The goalie blocked it! Try again!';
  if(sGoals >= 3) {
    sOn = false;
    document.getElementById('popup-body').innerHTML =
      '<div class="outcome win" style="font-size:1.1em;margin:12px 0">üèÜ You scored 3 goals in ' + sScore + ' shots!<br>' + getN() + ' does a victory lap around the arena!</div>' +
      '<button class="game-choice-btn" onclick="startSoccer()">Play Again</button>' +
      '<button class="game-choice-btn" onclick="openGameMenu()">‚Üê Back</button>';
    return;
  }
  drawSoccer(msg);
}

// ---- POPUP ----
function showPopup(title, text, extra) {
  document.getElementById('popup-title').textContent = title;
  document.getElementById('popup-body').innerHTML = (text ? '<div class="popup-text">' + text + '</div>' : '') + (extra || '');
  document.getElementById('popup').classList.add('open');
}
function closePopup() {
  document.getElementById('popup').classList.remove('open');
}
</script>

</body>
</html>
