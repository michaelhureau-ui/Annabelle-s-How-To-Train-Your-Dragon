<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Dragon World ‚Äî Berk</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
:root {
  --gold:#ffd700; --dark-gold:#c8a000; --sky-day:#5ba3dc; --sky-night:#0a0a2e;
  --ground:#3d6b2a; --ground-dark:#1a3a0a; --stone:#8a7a6a; --wood:#8b5e3c;
}
*{box-sizing:border-box;margin:0;padding:0;user-select:none;}
body{font-family:'Crimson Text',Georgia,serif;overflow:hidden;background:#000;width:100vw;height:100vh;}

/* ===== SCREENS ===== */
.screen{display:none;width:100vw;height:100vh;}
.screen.active{display:block;}

/* ===== TITLE / CHOOSE SCREEN ===== */
#s-title{
background:radial-gradient(ellipse at 50% 80%, #1a3a0a 0%, #0a1a05 60%, #000 100%);
display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
padding:16px 12px 100px; overflow-y:auto;
}
#s-title h1{
font-family:‚ÄòCinzel‚Äô,serif; font-size:clamp(1.4em,5vw,2.4em); color:var(‚Äìgold);
text-shadow:0 0 30px #ff8c00, 0 0 60px #ff4500; margin-bottom:4px; text-align:center;
}
.subtitle{color:#aad4ff;font-size:1em;margin-bottom:18px;text-align:center;}

.step-header{font-family:‚ÄòCinzel‚Äô,serif;color:var(‚Äìgold);font-size:1em;margin:14px 0 8px;text-align:center;letter-spacing:1px;}

/* Dragon choose grid */
.dragon-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;max-width:640px;width:100%;margin-bottom:4px;}
.dragon-card{
background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.15);
border-radius:14px;padding:10px 6px;text-align:center;cursor:pointer;transition:all 0.25s;
}
.dragon-card:hover,.dragon-card.sel{border-color:var(‚Äìgold);background:rgba(255,215,0,0.12);transform:scale(1.04);}
.dc-canvas{display:block;margin:0 auto 4px;}
.dc-name{font-family:‚ÄòCinzel‚Äô,serif;font-weight:700;color:var(‚Äìgold);font-size:0.78em;}
.dc-type{font-size:0.68em;color:#aad4ff;}

/* Viking creator */
.viking-creator{
background:rgba(255,255,255,0.05);border:1px solid rgba(255,215,0,0.2);
border-radius:16px;padding:14px;max-width:500px;width:100%;margin:0 auto;
}
.viking-preview{display:flex;justify-content:center;margin-bottom:10px;}
.vc-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.vc-label{color:var(‚Äìgold);font-family:‚ÄòCinzel‚Äô,serif;font-size:0.78em;width:60px;flex-shrink:0;}
.vc-options{display:flex;gap:6px;flex-wrap:wrap;}
.vc-opt{
width:28px;height:28px;border-radius:50%;border:2px solid transparent;
cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;font-size:0.85em;
}
.vc-opt:hover,.vc-opt.sel{border-color:white;transform:scale(1.2);}
.vc-text{
background:rgba(0,0,0,0.4);border:1px solid rgba(255,215,0,0.3);border-radius:8px;
padding:5px 9px;color:white;font-size:0.9em;width:140px;
}

.start-btn{
display:block;margin:14px auto 0;padding:13px 35px;border-radius:15px;border:none;
background:linear-gradient(135deg,var(‚Äìgold),#ff8c00);color:#1a0a00;
font-family:‚ÄòCinzel‚Äô,serif;font-size:1em;font-weight:700;cursor:pointer;
box-shadow:0 4px 20px rgba(255,165,0,0.5);transition:all 0.2s;
}
.start-btn:hover{transform:scale(1.05);box-shadow:0 6px 30px rgba(255,165,0,0.7);}

/* ===== WORLD SCREEN ===== */
#s-world{position:relative;overflow:hidden;}
#world-canvas{position:absolute;top:0;left:0;width:100%;height:100%;}

/* Mode badge */
#mode-badge{
position:absolute;top:8px;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,0.7);border:1px solid rgba(255,215,0,0.5);
border-radius:20px;padding:5px 16px;font-family:‚ÄòCinzel‚Äô,serif;
font-size:0.85em;color:var(‚Äìgold);z-index:30;pointer-events:none;
}

/* HUD */
#hud{position:absolute;top:8px;left:8px;right:8px;z-index:30;display:flex;justify-content:space-between;pointer-events:none;}
.hud-box{background:rgba(0,0,0,0.7);border:1px solid rgba(255,215,0,0.3);border-radius:10px;padding:7px 10px;pointer-events:all;}
.hud-name{font-family:‚ÄòCinzel‚Äô,serif;color:var(‚Äìgold);font-size:0.78em;margin-bottom:3px;}
.srow{display:flex;align-items:center;gap:5px;margin-top:2px;}
.slabel{font-size:0.65em;color:#aad4ff;width:48px;}
.sbar{width:65px;height:8px;background:rgba(255,255,255,0.15);border-radius:4px;overflow:hidden;}
.sfill{height:100%;border-radius:4px;transition:width 0.5s;}
.f-food{background:linear-gradient(90deg,#ff6b35,#ffd700);}
.f-water{background:linear-gradient(90deg,#4fc3f7,#0288d1);}
.f-happy{background:linear-gradient(90deg,#f06292,#e91e63);}
.f-coins{background:linear-gradient(90deg,#ffd700,#ff8c00);}
#coin-num{font-size:0.65em;color:var(‚Äìgold);margin-left:3px;}

/* Controls */
#controls{position:absolute;bottom:0;left:0;right:0;z-index:30;display:flex;justify-content:space-between;align-items:flex-end;padding:10px 12px 14px;pointer-events:none;}
#dpad{display:grid;grid-template-columns:repeat(3,42px);grid-template-rows:repeat(3,42px);gap:3px;pointer-events:all;}
.dp{background:rgba(0,0,0,0.75);border:1.5px solid rgba(255,255,255,0.25);border-radius:9px;font-size:1.1em;display:flex;align-items:center;justify-content:center;cursor:pointer;color:white;-webkit-tap-highlight-color:transparent;}
.dp:active,.dp.pr{background:rgba(255,215,0,0.35);border-color:var(‚Äìgold);}
#mode-btns{display:flex;flex-direction:column;gap:6px;align-items:flex-end;pointer-events:all;}
.mbtn{padding:9px 16px;border-radius:11px;border:2px solid rgba(255,255,255,0.25);font-family:‚ÄòCinzel‚Äô,serif;font-size:0.78em;font-weight:700;cursor:pointer;color:white;min-width:82px;transition:all 0.2s;}
.mbtn.am{border-color:var(‚Äìgold);transform:scale(1.06);}
#mb-walk{background:linear-gradient(135deg,#27ae60,#1e8449);}
#mb-run{background:linear-gradient(135deg,#e67e22,#d35400);}
#mb-fly{background:linear-gradient(135deg,#2980b9,#1a5276);}

#action-bar{position:absolute;bottom:140px;left:50%;transform:translateX(-50%);z-index:30;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;max-width:95vw;}
.abtn{padding:8px 11px;border-radius:10px;border:none;font-family:‚ÄòCinzel‚Äô,serif;font-size:0.68em;font-weight:700;cursor:pointer;color:white;white-space:nowrap;}
.ab-feed{background:linear-gradient(135deg,#e67e22,#d35400);}
.ab-water{background:linear-gradient(135deg,#2980b9,#1a5276);}
.ab-arena{background:linear-gradient(135deg,#8e44ad,#6c3483);}
.ab-battle{background:linear-gradient(135deg,#c0392b,#922b21);}
.ab-shop{background:linear-gradient(135deg,#d4ac0d,#a07800);}
.ab-game{background:linear-gradient(135deg,#16a085,#1abc9c);}
.ab-sleep{background:linear-gradient(135deg,#2c3e50,#1a252f);}

/* Coin flash */
.cflash{position:fixed;top:42%;left:50%;transform:translateX(-50%);font-family:‚ÄòCinzel‚Äô,serif;font-size:1.3em;color:var(‚Äìgold);font-weight:700;z-index:999;pointer-events:none;animation:cup 1s ease forwards;}
@keyframes cup{0%{opacity:1;top:42%}100%{opacity:0;top:26%}}

/* ===== POPUP ===== */
.pov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.82);z-index:200;display:none;align-items:center;justify-content:center;padding:14px;}
.pov.open{display:flex;}
.pop{
background:linear-gradient(135deg,#1a1205,#0d0a00);
border:2px solid rgba(255,215,0,0.4);border-radius:18px;
padding:20px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto;text-align:center;
box-shadow:0 0 40px rgba(255,165,0,0.2);
}
.pop-title{font-family:‚ÄòCinzel‚Äô,serif;font-size:1.1em;color:var(‚Äìgold);margin-bottom:10px;}
.pop-text{line-height:1.7;color:#e0d0b0;font-size:0.95em;margin-bottom:8px;}
.outcome{font-weight:700;margin-top:8px;font-size:1em;}
.win{color:#2ecc71;}.lose{color:#e74c3c;}
.cbtn{padding:9px 20px;border-radius:11px;border:none;background:linear-gradient(135deg,var(‚Äìgold),#ff8c00);color:#1a0a00;font-family:‚ÄòCinzel‚Äô,serif;font-weight:700;cursor:pointer;margin-top:10px;}
.gcbtn{padding:9px 13px;border-radius:12px;border:1.5px solid rgba(255,215,0,0.35);background:rgba(255,215,0,0.08);color:var(‚Äìgold);font-family:‚ÄòCinzel‚Äô,serif;font-size:0.82em;cursor:pointer;margin:3px;}
.gcbtn:hover{background:rgba(255,215,0,0.2);}
.ttt-board{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-width:210px;margin:8px auto;}
.tttc{height:62px;background:rgba(255,255,255,0.08);border:1.5px solid rgba(255,215,0,0.25);border-radius:9px;font-size:1.9em;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.tttc:hover{background:rgba(255,215,0,0.12);}
.card-area{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin:7px 0;}
.card{width:56px;height:80px;border-radius:9px;border:1.5px solid var(‚Äìgold);background:linear-gradient(135deg,#1a3a6e,#0d2137);font-size:1.6em;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.2s;}
.card:hover{transform:scale(1.1) translateY(-4px);}
.card.flip{background:linear-gradient(135deg,#2d5a1b,#1a3a0a);}
.aim-row{display:flex;gap:8px;justify-content:center;margin:8px 0;}
.aim-btn{padding:7px 13px;border-radius:9px;border:1.5px solid rgba(255,255,255,0.25);background:rgba(255,255,255,0.08);color:white;cursor:pointer;font-size:0.88em;}
.aim-btn:hover{border-color:var(‚Äìgold);background:rgba(255,215,0,0.15);}
.goal-box{width:100px;height:60px;border:3.5px solid white;border-bottom:none;margin:0 auto 7px;border-radius:4px 4px 0 0;position:relative;background:rgba(255,255,255,0.04);}
.shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;margin:8px 0;}
.si{background:rgba(255,255,255,0.06);border:1.5px solid rgba(255,215,0,0.25);border-radius:12px;padding:10px;text-align:center;cursor:pointer;transition:all 0.2s;}
.si:hover{border-color:var(‚Äìgold);background:rgba(255,215,0,0.12);}
.si.own{border-color:#2ecc71;background:rgba(46,204,113,0.1);cursor:default;}
.si.own:hover{transform:none;}
.si-e{font-size:1.7em;margin-bottom:3px;}
.si-n{font-family:‚ÄòCinzel‚Äô,serif;color:var(‚Äìgold);font-size:0.76em;font-weight:700;}
.si-p{color:#aad4ff;font-size:0.7em;margin-top:2px;}
.own-tag{color:#2ecc71;font-size:0.7em;font-weight:700;}
.cdsp{font-family:‚ÄòCinzel‚Äô,serif;color:var(‚Äìgold);font-size:0.95em;margin-bottom:10px;}

/* Arena / Battle UI */
.arena-btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0;}
.arena-btn{padding:10px 14px;border-radius:12px;border:1.5px solid rgba(255,215,0,0.3);background:rgba(255,215,0,0.08);color:var(‚Äìgold);font-family:‚ÄòCinzel‚Äô,serif;font-size:0.82em;cursor:pointer;transition:all 0.2s;}
.arena-btn:hover{background:rgba(255,215,0,0.2);transform:scale(1.04);}
.hp-row{display:flex;gap:10px;justify-content:center;margin:8px 0;}
.hp-box{flex:1;max-width:140px;}
.hp-label{font-family:‚ÄòCinzel‚Äô,serif;font-size:0.72em;color:var(‚Äìgold);margin-bottom:3px;}
.hp-bar{height:14px;background:rgba(255,255,255,0.15);border-radius:7px;overflow:hidden;}
.hp-fill{height:100%;border-radius:7px;background:linear-gradient(90deg,#e74c3c,#ff6b35);transition:width 0.4s;}
.enemy-face{font-size:3em;margin:8px 0;}
</style>

</head>
<body>

<!-- ===== TITLE / CHOOSE SCREEN ===== -->

<div id="s-title" class="screen active">
  <h1>üêâ Dragon World</h1>
  <p class="subtitle">Isle of Berk ‚Äî How to Train Your Dragon</p>

  <!-- Step 1: Choose Dragon -->

  <p class="step-header">‚öîÔ∏è Choose Your Dragon</p>
  <div class="dragon-grid" id="dragon-grid">
    <!-- Cards filled by JS -->
  </div>

  <!-- Step 2: Create Viking -->

  <p class="step-header">ü™ñ Create Your Viking</p>
  <div class="viking-creator">
    <div class="viking-preview"><canvas id="viking-canvas" width="80" height="100"></canvas></div>
    <div class="vc-row">
      <span class="vc-label">Name:</span>
      <input class="vc-text" id="viking-name" type="text" placeholder="e.g. Astrid...">
    </div>
    <div class="vc-row">
      <span class="vc-label">Skin:</span>
      <div class="vc-options" id="skin-opts">
        <div class="vc-opt sel" style="background:#f5c5a3" onclick="setViking('skin','#f5c5a3',this)"></div>
        <div class="vc-opt" style="background:#c68642" onclick="setViking('skin','#c68642',this)"></div>
        <div class="vc-opt" style="background:#8d5524" onclick="setViking('skin','#8d5524',this)"></div>
        <div class="vc-opt" style="background:#fde8c8" onclick="setViking('skin','#fde8c8',this)"></div>
      </div>
    </div>
    <div class="vc-row">
      <span class="vc-label">Hair:</span>
      <div class="vc-options" id="hair-opts">
        <div class="vc-opt sel" style="background:#3d2b1f" onclick="setViking('hair','#3d2b1f',this)"></div>
        <div class="vc-opt" style="background:#c8a045" onclick="setViking('hair','#c8a045',this)"></div>
        <div class="vc-opt" style="background:#8b0000" onclick="setViking('hair','#8b0000',this)"></div>
        <div class="vc-opt" style="background:#aaa" onclick="setViking('hair','#aaa',this)"></div>
        <div class="vc-opt" style="background:#1a1a1a" onclick="setViking('hair','#1a1a1a',this)"></div>
      </div>
    </div>
    <div class="vc-row">
      <span class="vc-label">Tunic:</span>
      <div class="vc-options" id="tunic-opts">
        <div class="vc-opt sel" style="background:#4a6741" onclick="setViking('tunic','#4a6741',this)"></div>
        <div class="vc-opt" style="background:#7a4530" onclick="setViking('tunic','#7a4530',this)"></div>
        <div class="vc-opt" style="background:#2a4a7a" onclick="setViking('tunic','#2a4a7a',this)"></div>
        <div class="vc-opt" style="background:#5a3a6a" onclick="setViking('tunic','#5a3a6a',this)"></div>
        <div class="vc-opt" style="background:#2a2a2a" onclick="setViking('tunic','#2a2a2a',this)"></div>
      </div>
    </div>
    <div class="vc-row">
      <span class="vc-label">Helmet:</span>
      <div class="vc-options" id="helm-opts">
        <div class="vc-opt sel" style="background:#888;font-size:1.1em" onclick="setViking('helm','iron',this)">ü™ñ</div>
        <div class="vc-opt" style="background:#c8a000;font-size:1.1em" onclick="setViking('helm','gold',this)">üëë</div>
        <div class="vc-opt" style="background:#555;font-size:1.1em" onclick="setViking('helm','horn',this)">üêÇ</div>
        <div class="vc-opt" style="background:transparent;border:1.5px solid #555;font-size:0.9em" onclick="setViking('helm','none',this)">‚úó</div>
      </div>
    </div>
    <div class="vc-row">
      <span class="vc-label">Dragon:</span>
      <input class="vc-text" id="dragon-name" type="text" placeholder="Nickname...">
    </div>
  </div>

<button class="start-btn" onclick="startWorld()">Enter Berk! üêâ</button>

</div>

<!-- ===== WORLD SCREEN ===== -->

<div id="s-world" class="screen">
  <canvas id="world-canvas"></canvas>

  <div id="mode-badge">üö∂ Walking</div>

  <div id="hud">
    <div class="hud-box">
      <div class="hud-name" id="hud-name">Viking</div>
      <div style="font-size:0.65em;color:#aad4ff" id="hud-dragon-name"></div>
    </div>
    <div class="hud-box">
      <div class="srow"><span class="slabel">üçñ Food</span><div class="sbar"><div class="sfill f-food" id="b-food" style="width:70%"></div></div></div>
      <div class="srow"><span class="slabel">üíß Water</span><div class="sbar"><div class="sfill f-water" id="b-water" style="width:70%"></div></div></div>
      <div class="srow"><span class="slabel">üòÑ Happy</span><div class="sbar"><div class="sfill f-happy" id="b-happy" style="width:70%"></div></div></div>
      <div class="srow"><span class="slabel">ü™ô Coins</span><div class="sbar"><div class="sfill f-coins" id="b-coins" style="width:0%"></div></div><span id="coin-num">0</span></div>
    </div>
  </div>

  <div id="action-bar">
    <button class="abtn ab-feed"   onclick="feedDragon()">üêü Feed</button>
    <button class="abtn ab-water"  onclick="waterDragon()">üíß Water</button>
    <button class="abtn ab-arena"  onclick="openArena()">üèãÔ∏è Train</button>
    <button class="abtn ab-battle" onclick="openBattle()">‚öîÔ∏è Battle</button>
    <button class="abtn ab-shop"   onclick="openShop()">üî® Shop</button>
    <button class="abtn ab-game"   onclick="openGameMenu()">üéÆ Games</button>
    <button class="abtn ab-sleep"  onclick="trySleep()">üåô Sleep</button>
  </div>

  <div id="controls">
    <div id="dpad">
      <div></div>
      <div class="dp" onpointerdown="dk('up',1)" onpointerup="dk('up',0)" onpointerleave="dk('up',0)">‚ñ≤</div>
      <div></div>
      <div class="dp" onpointerdown="dk('left',1)" onpointerup="dk('left',0)" onpointerleave="dk('left',0)">‚óÑ</div>
      <div style="background:rgba(0,0,0,0.3);border-radius:9px;"></div>
      <div class="dp" onpointerdown="dk('right',1)" onpointerup="dk('right',0)" onpointerleave="dk('right',0)">‚ñ∫</div>
      <div></div>
      <div class="dp" onpointerdown="dk('down',1)" onpointerup="dk('down',0)" onpointerleave="dk('down',0)">‚ñº</div>
      <div></div>
    </div>
    <div id="mode-btns">
      <button class="mbtn am" id="mb-walk" onclick="setMode('walk')">üö∂ Walk</button>
      <button class="mbtn" id="mb-run" onclick="setMode('run')">üí® Run</button>
      <button class="mbtn" id="mb-fly" onclick="setMode('fly')">ü¶Ö Fly</button>
    </div>
  </div>
</div>

<!-- POPUP -->

<div class="pov" id="popup">
  <div class="pop">
    <div class="pop-title" id="ptitle"></div>
    <div id="pbody"></div>
    <button class="cbtn" onclick="closePopup()">Close ‚úï</button>
  </div>
</div>

<script>
// ============================================================
// DRAGON DEFINITIONS with SVG-style canvas drawing
// ============================================================
var DRAGONS = [
  {id:'toothless', name:'Toothless', type:'Night Fury', color:'#1a1a2e', accent:'#4a4a8a', eye:'#22d3ee', fire:'#4af', desc:'The most powerful dragon', bodyShape:'sleek'},
  {id:'lightfury', name:'Light Fury', type:'Light Fury', color:'#e8e8f0', accent:'#b0b8d0', eye:'#a0d8ef', fire:'#aef', desc:'Pure and elegant', bodyShape:'sleek'},
  {id:'stormfly', name:'Stormfly', type:'Deadly Nadder', color:'#3a7bd5', accent:'#ffd700', eye:'#ff6b35', fire:'#fa0', desc:'Quick and loyal', bodyShape:'nadder'},
  {id:'hookfang', name:'Hookfang', type:'Monstrous Nightmare', color:'#cc2200', accent:'#ff6600', eye:'#ffd700', fire:'#f60', desc:'Bold and fierce', bodyShape:'nightmare'},
  {id:'meatlug', name:'Meatlug', type:'Gronckle', color:'#7a6a5a', accent:'#5a4a3a', eye:'#ffd700', fire:'#f80', desc:'Strong and sweet', bodyShape:'gronckle'},
  {id:'cloudjumper', name:'Cloudjumper', type:'Stormcutter', color:'#8a5a2a', accent:'#d4a050', eye:'#ff6b35', fire:'#fa3', desc:'Four-winged and wise', bodyShape:'stormcutter'},
];

// Draw a dragon on a canvas ctx
function drawDragon(ctx, dragon, x, y, scale, facingRight, flyMode, frame) {
  ctx.save();
  ctx.translate(x, y);
  if(!facingRight) ctx.scale(-1, 1);
  ctx.scale(scale, scale);

  var c = dragon.color;
  var a = dragon.accent;
  var e = dragon.eye;

  // Slight bob animation
  var bob = flyMode ? Math.sin(frame * 0.06) * 4 : 0;

  if(dragon.bodyShape === 'gronckle') {
    drawGronckle(ctx, c, a, e, bob, frame, flyMode);
  } else if(dragon.bodyShape === 'nadder') {
    drawNadder(ctx, c, a, e, bob, frame, flyMode);
  } else if(dragon.bodyShape === 'nightmare') {
    drawNightmare(ctx, c, a, e, bob, frame, flyMode);
  } else {
    drawSleekDragon(ctx, c, a, e, bob, frame, flyMode);
  }
  ctx.restore();
}

function drawSleekDragon(ctx, c, a, e, bob, frame, fly) {
  var wFlap = fly ? Math.sin(frame*0.15)*18 : Math.sin(frame*0.04)*5;
  // Wings
  ctx.fillStyle = a;
  ctx.globalAlpha = 0.85;
  // Left wing
  ctx.beginPath();
  ctx.moveTo(-5, -8+bob);
  ctx.bezierCurveTo(-30, -30+wFlap+bob, -60, -20+wFlap+bob, -55, 10+bob);
  ctx.bezierCurveTo(-40, 5+bob, -20, 0+bob, -5, 5+bob);
  ctx.fill();
  // Right wing
  ctx.beginPath();
  ctx.moveTo(5, -8+bob);
  ctx.bezierCurveTo(30, -30+wFlap+bob, 60, -20+wFlap+bob, 55, 10+bob);
  ctx.bezierCurveTo(40, 5+bob, 20, 0+bob, 5, 5+bob);
  ctx.fill();
  ctx.globalAlpha = 1;
  // Body
  ctx.fillStyle = c;
  ctx.beginPath();
  ctx.ellipse(0, 5+bob, 18, 12, 0, 0, Math.PI*2);
  ctx.fill();
  // Tail
  ctx.beginPath();
  ctx.moveTo(-14, 8+bob);
  ctx.bezierCurveTo(-30, 14+bob, -42, 8+bob, -38, 2+bob);
  ctx.bezierCurveTo(-34, -4+bob, -20, 2+bob, -14, 5+bob);
  ctx.fill();
  // Tail fin (Night Fury split tail)
  ctx.fillStyle = a;
  ctx.beginPath();
  ctx.moveTo(-38, 2+bob);
  ctx.bezierCurveTo(-50, -8+bob, -52, -15+bob, -46, -14+bob);
  ctx.bezierCurveTo(-42, -12+bob, -40, -5+bob, -38, 2+bob);
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(-38, 2+bob);
  ctx.bezierCurveTo(-50, 10+bob, -52, 18+bob, -46, 18+bob);
  ctx.bezierCurveTo(-42, 16+bob, -40, 8+bob, -38, 2+bob);
  ctx.fill();
  // Head
  ctx.fillStyle = c;
  ctx.beginPath();
  ctx.ellipse(16, -4+bob, 12, 9, -0.2, 0, Math.PI*2);
  ctx.fill();
  // Snout
  ctx.beginPath();
  ctx.ellipse(25, 0+bob, 7, 5, 0.3, 0, Math.PI*2);
  ctx.fill();
  // Eye
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.ellipse(20, -5+bob, 4.5, 5, -0.2, 0, Math.PI*2);
  ctx.fill();
  ctx.fillStyle = e;
  ctx.beginPath();
  ctx.ellipse(20, -5+bob, 3, 4, -0.2, 0, Math.PI*2);
  ctx.fill();
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.ellipse(21, -5.5+bob, 1.5, 2.5, -0.2, 0, Math.PI*2);
  ctx.fill();
  // Nostril
  ctx.fillStyle = a;
  ctx.beginPath();
  ctx.ellipse(27, 1+bob, 1.5, 1, 0, 0, Math.PI*2);
  ctx.fill();
  // Legs
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(-2, 16+bob, 4, 6, 0.2, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(8, 17+bob, 4, 6, -0.2, 0, Math.PI*2); ctx.fill();
  // Claws
  ctx.fillStyle = '#aaa';
  for(var i=-1;i<=1;i++){
    ctx.beginPath(); ctx.ellipse(-2+i*2.5, 22+bob, 1, 2.5, i*0.2, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(8+i*2.5, 23+bob, 1, 2.5, i*0.2, 0, Math.PI*2); ctx.fill();
  }
  // Spine spikes
  ctx.fillStyle = a;
  for(var s=0;s<4;s++){
    ctx.beginPath();
    var sx = -6+s*7, sy = -10+bob;
    ctx.moveTo(sx, sy); ctx.lineTo(sx-3, sy-8-s*1.5); ctx.lineTo(sx+3, sy); ctx.fill();
  }
}

function drawNadder(ctx, c, a, e, bob, frame, fly) {
  var wFlap = fly ? Math.sin(frame*0.15)*20 : Math.sin(frame*0.04)*6;
  // Wings
  ctx.fillStyle = a; ctx.globalAlpha = 0.8;
  ctx.beginPath();
  ctx.moveTo(0, 0+bob);
  ctx.bezierCurveTo(-20, -35+wFlap+bob, -55, -25+wFlap+bob, -50, 12+bob);
  ctx.bezierCurveTo(-30, 5+bob, -15, 3+bob, 0, 6+bob);
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(0, 0+bob);
  ctx.bezierCurveTo(20, -35+wFlap+bob, 55, -25+wFlap+bob, 50, 12+bob);
  ctx.bezierCurveTo(30, 5+bob, 15, 3+bob, 0, 6+bob);
  ctx.fill();
  ctx.globalAlpha = 1;
  // Body
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(0, 8+bob, 14, 10, 0, 0, Math.PI*2); ctx.fill();
  // Long neck
  ctx.beginPath(); ctx.moveTo(5, 0+bob); ctx.lineTo(14, -18+bob); ctx.lineTo(20, -16+bob); ctx.lineTo(8, 4+bob); ctx.fill();
  // Head (smaller, rounder for Nadder)
  ctx.beginPath(); ctx.ellipse(17, -22+bob, 9, 7, -0.3, 0, Math.PI*2); ctx.fill();
  // Beak
  ctx.fillStyle = a;
  ctx.beginPath(); ctx.moveTo(24, -22+bob); ctx.lineTo(35, -20+bob); ctx.lineTo(24, -17+bob); ctx.fill();
  // Eye
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.ellipse(14, -24+bob, 3.5, 4, -0.3, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = e; ctx.beginPath(); ctx.ellipse(14, -24+bob, 2.5, 3, -0.3, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#000'; ctx.beginPath(); ctx.ellipse(14.5, -24.5+bob, 1.2, 2, -0.3, 0, Math.PI*2); ctx.fill();
  // Tail
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.moveTo(-12, 10+bob); ctx.bezierCurveTo(-28, 12+bob, -38, 5+bob, -35, -2+bob); ctx.bezierCurveTo(-30, -6+bob, -18, 2+bob, -12, 6+bob); ctx.fill();
  // Tail spikes
  ctx.fillStyle = a;
  for(var i=0;i<3;i++){
    ctx.beginPath(); ctx.moveTo(-28+i*5, -2+bob); ctx.lineTo(-30+i*5, -12-i*3+bob); ctx.lineTo(-24+i*5, -2+bob); ctx.fill();
  }
  // Back spikes
  ctx.fillStyle = a;
  for(var s=0;s<5;s++){
    ctx.beginPath(); ctx.moveTo(-8+s*5, -3+bob); ctx.lineTo(-9+s*5, -11-s+bob); ctx.lineTo(-5+s*5, -3+bob); ctx.fill();
  }
  // Legs
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(-4, 18+bob, 3, 5, 0.2, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(6, 18+bob, 3, 5, -0.2, 0, Math.PI*2); ctx.fill();
}

function drawNightmare(ctx, c, a, e, bob, frame, fly) {
  var wFlap = fly ? Math.sin(frame*0.14)*22 : Math.sin(frame*0.04)*5;
  // Long wings (Nightmare style)
  ctx.fillStyle = a; ctx.globalAlpha = 0.85;
  ctx.beginPath();
  ctx.moveTo(0, 0+bob);
  ctx.bezierCurveTo(-15, -28+wFlap+bob, -65, -18+wFlap+bob, -60, 15+bob);
  ctx.bezierCurveTo(-40, 8+bob, -20, 5+bob, 0, 8+bob);
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(0, 0+bob);
  ctx.bezierCurveTo(15, -28+wFlap+bob, 65, -18+wFlap+bob, 60, 15+bob);
  ctx.bezierCurveTo(40, 8+bob, 20, 5+bob, 0, 8+bob);
  ctx.fill();
  ctx.globalAlpha = 1;
  // Larger body
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(0, 10+bob, 20, 13, 0, 0, Math.PI*2); ctx.fill();
  // Head
  ctx.beginPath(); ctx.ellipse(18, -2+bob, 14, 10, -0.15, 0, Math.PI*2); ctx.fill();
  // Horns
  ctx.fillStyle = a;
  ctx.beginPath(); ctx.moveTo(22, -10+bob); ctx.lineTo(18, -22+bob); ctx.lineTo(26, -10+bob); ctx.fill();
  ctx.beginPath(); ctx.moveTo(16, -11+bob); ctx.lineTo(10, -22+bob); ctx.lineTo(18, -11+bob); ctx.fill();
  // Snout
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(29, 2+bob, 8, 5.5, 0.25, 0, Math.PI*2); ctx.fill();
  // Eye
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.ellipse(22, -3+bob, 5, 6, -0.1, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = e; ctx.beginPath(); ctx.ellipse(22, -3+bob, 3.5, 5, -0.1, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#000'; ctx.beginPath(); ctx.ellipse(23, -3.5+bob, 1.5, 3, -0.1, 0, Math.PI*2); ctx.fill();
  // Tail
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.moveTo(-16, 14+bob); ctx.bezierCurveTo(-35, 16+bob, -48, 6+bob, -44, -2+bob); ctx.bezierCurveTo(-38, -8+bob, -24, 4+bob, -16, 10+bob); ctx.fill();
  ctx.fillStyle = a;
  ctx.beginPath(); ctx.moveTo(-44, -2+bob); ctx.bezierCurveTo(-55, -14+bob, -58, -22+bob, -52, -18+bob); ctx.bezierCurveTo(-48, -14+bob, -46, -8+bob, -44, -2+bob); ctx.fill();
  // Legs
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(-4, 22+bob, 5, 7, 0.2, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(8, 23+bob, 5, 7, -0.2, 0, Math.PI*2); ctx.fill();
  // Spines
  ctx.fillStyle = a;
  for(var s=0;s<5;s++){
    ctx.beginPath(); ctx.moveTo(-10+s*7, -4+bob); ctx.lineTo(-12+s*7, -14-s*1.5+bob); ctx.lineTo(-6+s*7, -4+bob); ctx.fill();
  }
}

function drawGronckle(ctx, c, a, e, bob, frame, fly) {
  var wFlap = fly ? Math.sin(frame*0.12)*14 : Math.sin(frame*0.04)*3;
  // Small stubby wings
  ctx.fillStyle = a; ctx.globalAlpha=0.8;
  ctx.beginPath(); ctx.moveTo(-5, 0+bob); ctx.bezierCurveTo(-20, -20+wFlap+bob, -40, -10+wFlap+bob, -35, 10+bob); ctx.bezierCurveTo(-22, 5+bob, -12, 3+bob, -5, 5+bob); ctx.fill();
  ctx.beginPath(); ctx.moveTo(5, 0+bob); ctx.bezierCurveTo(20, -20+wFlap+bob, 40, -10+wFlap+bob, 35, 10+bob); ctx.bezierCurveTo(22, 5+bob, 12, 3+bob, 5, 5+bob); ctx.fill();
  ctx.globalAlpha=1;
  // Fat round body
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(0, 10+bob, 22, 16, 0, 0, Math.PI*2); ctx.fill();
  // Rocky bumps
  ctx.fillStyle = a;
  for(var i=0;i<6;i++){
    var bx=[-14,-5,4,12,-10,8][i], by=[-2,2,-4,0,10,8][i];
    ctx.beginPath(); ctx.ellipse(bx, by+bob, 4, 3, i*0.5, 0, Math.PI*2); ctx.fill();
  }
  // Round head
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(18, 2+bob, 13, 11, -0.1, 0, Math.PI*2); ctx.fill();
  // Eye
  ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.ellipse(15, -1+bob, 4, 5, -0.1, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = e; ctx.beginPath(); ctx.ellipse(15, -1+bob, 3, 4, -0.1, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#000'; ctx.beginPath(); ctx.ellipse(15.5, -1.5+bob, 1.3, 2.2, -0.1, 0, Math.PI*2); ctx.fill();
  // Snout / jaw
  ctx.fillStyle = c;
  ctx.beginPath(); ctx.ellipse(28, 4+bob, 8, 6, 0.2, 0, Math.PI*2); ctx.fill();
  // Stubby legs
  ctx.beginPath(); ctx.ellipse(-6, 25+bob, 6, 5, 0.1, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(6, 26+bob, 6, 5, -0.1, 0, Math.PI*2); ctx.fill();
  // Tail (short)
  ctx.beginPath(); ctx.moveTo(-20, 14+bob); ctx.bezierCurveTo(-32, 12+bob, -38, 6+bob, -34, 2+bob); ctx.bezierCurveTo(-28, 0+bob, -22, 8+bob, -20, 12+bob); ctx.fill();
}

// Draw Viking character on canvas
function drawVikingOn(ctx, vc, x, y, scale) {
  ctx.save();
  ctx.translate(x, y);
  ctx.scale(scale, scale);
  // Legs
  ctx.fillStyle='#5a5050';
  ctx.fillRect(-6, 20, 5, 18);
  ctx.fillRect(2, 20, 5, 18);
  // Boots
  ctx.fillStyle='#3a2a1a';
  ctx.fillRect(-7, 34, 7, 5);
  ctx.fillRect(1, 34, 7, 5);
  // Tunic / body
  ctx.fillStyle = vc.tunic;
  ctx.beginPath(); ctx.roundRect(-12, 0, 25, 24, 4); ctx.fill();
  // Belt
  ctx.fillStyle='#3a2a1a';
  ctx.fillRect(-12, 18, 25, 4);
  // Arms
  ctx.fillStyle = vc.tunic;
  ctx.fillRect(-18, 2, 8, 16);
  ctx.fillRect(11, 2, 8, 16);
  // Hands
  ctx.fillStyle = vc.skin;
  ctx.beginPath(); ctx.ellipse(-14, 19, 4, 4, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(15, 19, 4, 4, 0, 0, Math.PI*2); ctx.fill();
  // Neck
  ctx.fillStyle = vc.skin;
  ctx.fillRect(-4, -8, 9, 10);
  // Head
  ctx.beginPath(); ctx.ellipse(0, -18, 13, 13, 0, 0, Math.PI*2); ctx.fill();
  // Hair
  ctx.fillStyle = vc.hair;
  ctx.beginPath(); ctx.ellipse(0, -24, 13, 8, 0, Math.PI, Math.PI*2); ctx.fill();
  if(vc.helm === 'none') {
    // Side hair
    ctx.beginPath(); ctx.ellipse(-11, -18, 4, 8, -0.3, 0, Math.PI*2); ctx.fill();
  }
  // Eyes
  ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.ellipse(-5, -18, 3, 3.5, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(5, -18, 3, 3.5, 0, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle='#3a2010';
  ctx.beginPath(); ctx.ellipse(-5, -18, 1.8, 2.2, 0, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(5, -18, 1.8, 2.2, 0, 0, Math.PI*2); ctx.fill();
  // Nose
  ctx.fillStyle = vc.skin;
  ctx.beginPath(); ctx.ellipse(0, -15, 2, 2.5, 0, 0, Math.PI*2); ctx.fill();
  // Helmet
  if(vc.helm === 'iron') {
    ctx.fillStyle='#888';
    ctx.beginPath(); ctx.ellipse(0, -26, 14, 10, 0, Math.PI, Math.PI*2); ctx.fill();
    ctx.fillRect(-14, -26, 28, 4);
    ctx.fillStyle='#666';
    ctx.fillRect(-2, -28, 4, 14);
  } else if(vc.helm === 'gold') {
    ctx.fillStyle='#c8a000';
    ctx.beginPath(); ctx.ellipse(0, -26, 14, 10, 0, Math.PI, Math.PI*2); ctx.fill();
    ctx.fillRect(-14, -26, 28, 4);
    for(var p=0;p<5;p++){ ctx.beginPath(); ctx.moveTo(-10+p*5,-26); ctx.lineTo(-8+p*5,-34); ctx.lineTo(-6+p*5,-26); ctx.fill(); }
  } else if(vc.helm === 'horn') {
    ctx.fillStyle='#666';
    ctx.beginPath(); ctx.ellipse(0, -26, 14, 10, 0, Math.PI, Math.PI*2); ctx.fill();
    ctx.fillRect(-14, -26, 28, 4);
    ctx.fillStyle='#ddd';
    ctx.beginPath(); ctx.moveTo(-14,-26); ctx.bezierCurveTo(-22,-30,-26,-38,-20,-36); ctx.bezierCurveTo(-16,-34,-14,-28,-14,-26); ctx.fill();
    ctx.beginPath(); ctx.moveTo(14,-26); ctx.bezierCurveTo(22,-30,26,-38,20,-36); ctx.bezierCurveTo(16,-34,14,-28,14,-26); ctx.fill();
  }
  ctx.restore();
}

// ============================================================
// GAME STATE
// ============================================================
var viking = {skin:'#f5c5a3', hair:'#3d2b1f', tunic:'#4a6741', helm:'iron', name:'Viking'};
var dragonData = DRAGONS[0];
var dragonNickname = 'Toothless';
var stats = {food:70,water:70,happy:70};
var coins = 0; var MAX_COINS=100; var ownedSaddles=[];
var mode='walk'; var keys={up:0,down:0,left:0,right:0};
var drX=200, drY=0, velY=0, facing=1, animFrame=0;
var isNight=false, sleepFade=0, dayTime=0;
var worldCanvas, wctx;
var worldW, worldH, groundLevel;
// House state
var nearHouse=false, insideHouse=false;
var houseX=120, houseY=0;

var saddles=[
  {id:'basic',emoji:'üü§',name:'Basic Saddle',price:5,desc:'A sturdy saddle!'},
  {id:'royal',emoji:'üëë',name:'Royal Saddle',price:15,desc:'Fit for a champion!'},
  {id:'fire',emoji:'üî•',name:'Fire Saddle',price:20,desc:'Heat-resistant!'},
  {id:'shadow',emoji:'üåë',name:'Shadow Saddle',price:25,desc:'Blends into night!'},
  {id:'ice',emoji:'‚ùÑÔ∏è',name:'Ice Saddle',price:30,desc:'Cool and sleek!'},
  {id:'golden',emoji:'‚ú®',name:'Golden Saddle',price:40,desc:'Rarest in Berk!'}
];

// Floating coins positions
var floatCoins=[];

// ============================================================
// TITLE SCREEN - Build Dragon Cards
// ============================================================
window.onload = function() {
  var grid = document.getElementById('dragon-grid');
  DRAGONS.forEach(function(dr, idx) {
    var div = document.createElement('div');
    div.className='dragon-card'+(idx===0?' sel':'');
    div.onclick = function(){ selectDragon(dr, div); };
    var cv = document.createElement('canvas');
    cv.className='dc-canvas'; cv.width=90; cv.height=70;
    var cx = cv.getContext('2d');
    drawDragon(cx, dr, 30, 55, 0.7, true, false, 0);
    div.appendChild(cv);
    var n=document.createElement('div'); n.className='dc-name'; n.textContent=dr.name; div.appendChild(n);
    var t=document.createElement('div'); t.className='dc-type'; t.textContent=dr.type; div.appendChild(t);
    grid.appendChild(div);
  });
  drawVikingPreview();
};

function selectDragon(dr, el) {
  dragonData = dr;
  document.querySelectorAll('.dragon-card').forEach(function(c){c.classList.remove('sel');});
  el.classList.add('sel');
}

function setViking(prop, val, el) {
  viking[prop]=val;
  var grp=prop+'-opts';
  if(document.getElementById(grp)){
    document.querySelectorAll('#'+grp+' .vc-opt').forEach(function(o){o.classList.remove('sel');});
    el.classList.add('sel');
  }
  drawVikingPreview();
}

function drawVikingPreview() {
  var cv=document.getElementById('viking-canvas');
  var cx=cv.getContext('2d');
  cx.clearRect(0,0,80,100);
  drawVikingOn(cx, viking, 40, 75, 1);
}

// ============================================================
// WORLD INIT
// ============================================================
function startWorld() {
  viking.name = document.getElementById('viking-name').value || 'Viking';
  dragonNickname = document.getElementById('dragon-name').value || dragonData.name;
  document.getElementById('hud-name').textContent = viking.name;
  document.getElementById('hud-dragon-name').textContent = dragonNickname + ' the ' + dragonData.type;

  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById('s-world').classList.add('active');

  worldCanvas=document.getElementById('world-canvas');
  wctx=worldCanvas.getContext('2d');
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  drX = worldW*0.35;
  spawnCoins();
  setInterval(spawnCoins, 14000);
  setInterval(function(){changeStat('food',-1);changeStat('water',-1);},15000);
  setInterval(function(){dayTime+=1; if(dayTime>=120){dayTime=0; toggleDayNight();}},1000);

  requestAnimationFrame(gameLoop);
}

function resizeCanvas() {
  worldW=worldCanvas.width=window.innerWidth;
  worldH=worldCanvas.height=window.innerHeight;
  groundLevel = worldH*0.58;
}

// ============================================================
// MAIN GAME LOOP
// ============================================================
function gameLoop() {
  requestAnimationFrame(gameLoop);
  animFrame++;
  update();
  render();
}

function update() {
  var speed={walk:2.5,run:6,fly:4}[mode];
  if(keys.left){drX-=speed; facing=-1;}
  if(keys.right){drX+=speed; facing=1;}
  drX=Math.max(40,Math.min(worldW-60,drX));

  if(mode==='fly'){
    if(keys.up) velY-=0.6;
    if(keys.down) velY+=0.6;
    velY*=0.9; drY-=velY;
    if(drY<0){drY=0;velY=0;}
    if(drY>worldH*0.45){drY=worldH*0.45;velY=0;}
  } else {drY=0; velY=0;}

  // Sleep fade
  if(sleepFade>0) sleepFade=Math.max(0,sleepFade-0.01);

  // Coin collection
  for(var i=floatCoins.length-1;i>=0;i--){
    var fc=floatCoins[i];
    var dx=fc.x-drX, dy=fc.y-(groundLevel-drY-30);
    if(Math.sqrt(dx*dx+dy*dy)<50){
      floatCoins.splice(i,1);
      coins=Math.min(MAX_COINS,coins+1);
      updateCoins();
      showFlash('+1 ü™ô');
    }
  }

  // Near house check (house at left side)
  nearHouse = (drX < houseX+80 && drX > houseX-80 && drY === 0);
}

// ============================================================
// RENDER
// ============================================================
function render() {
  var ctx=wctx;
  ctx.clearRect(0,0,worldW,worldH);

  if(!insideHouse) renderOutdoor(ctx);
  else renderIndoor(ctx);

  // Sleep overlay
  if(sleepFade>0){
    ctx.fillStyle='rgba(5,5,20,'+sleepFade+')';
    ctx.fillRect(0,0,worldW,worldH);
    if(sleepFade>0.6){
      ctx.fillStyle='rgba(255,215,0,'+(sleepFade-0.5)*2+')';
      ctx.font='bold 28px Cinzel,Georgia';
      ctx.textAlign='center';
      ctx.fillText('üí§ Sleeping... üí§',worldW/2,worldH/2);
    }
  }
}

function renderOutdoor(ctx) {
  var gl=groundLevel;

  // Sky gradient (day/night)
  var skyGrad=ctx.createLinearGradient(0,0,0,gl);
  if(isNight){
    skyGrad.addColorStop(0,'#030318');
    skyGrad.addColorStop(1,'#0a1a3a');
  } else {
    skyGrad.addColorStop(0,'#2a7ec8');
    skyGrad.addColorStop(1,'#87CEEB');
  }
  ctx.fillStyle=skyGrad;
  ctx.fillRect(0,0,worldW,gl);

  // Stars / sun
  if(isNight){
    ctx.fillStyle='rgba(255,255,200,0.8)';
    for(var s=0;s<60;s++){
      var sx=((s*197+83)%worldW), sy=((s*113+47)%(gl-40));
      var ss=Math.sin(animFrame*0.03+s)*0.5+1;
      ctx.beginPath(); ctx.arc(sx,sy,ss,0,Math.PI*2); ctx.fill();
    }
    // Moon
    ctx.fillStyle='#fffbe6';
    ctx.beginPath(); ctx.arc(worldW-100,60,28,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(5,5,30,0.5)';
    ctx.beginPath(); ctx.arc(worldW-110,55,24,0,Math.PI*2); ctx.fill();
  } else {
    // Sun
    ctx.fillStyle='#ffe44a';
    ctx.beginPath(); ctx.arc(worldW-90,55,30,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,228,74,0.3)';
    ctx.beginPath(); ctx.arc(worldW-90,55,46,0,Math.PI*2); ctx.fill();
    // Clouds
    drawCloud(ctx,120,60,1.0);
    drawCloud(ctx,350,40,0.8);
    drawCloud(ctx,worldW*0.6,80,1.1);
  }

  // Distant mountains
  ctx.fillStyle=isNight?'#0a1a10':'#2a5a3a';
  ctx.beginPath(); ctx.moveTo(0,gl);
  var mpts=[[0,gl],[60,gl-90],[140,gl-60],[250,gl-120],[380,gl-80],[480,gl-140],[580,gl-90],[700,gl-110],[worldW,gl-70],[worldW,gl]];
  for(var p=0;p<mpts.length;p++) ctx.lineTo(mpts[p][0],mpts[p][1]);
  ctx.fill();

  // Ground
  var gGrad=ctx.createLinearGradient(0,gl,0,worldH);
  gGrad.addColorStop(0,isNight?'#1a2a12':'#3d6b2a');
  gGrad.addColorStop(0.3,isNight?'#0d1a08':'#2a5a1a');
  gGrad.addColorStop(1,'#0a1005');
  ctx.fillStyle=gGrad;
  ctx.fillRect(0,gl,worldW,worldH-gl);

  // Grass tufts
  ctx.fillStyle=isNight?'#1a3010':'#4a7c2a';
  for(var g=0;g<worldW;g+=18){
    var gh=6+Math.sin(g*0.3)*4;
    ctx.beginPath(); ctx.moveTo(g,gl); ctx.lineTo(g+4,gl-gh); ctx.lineTo(g+9,gl); ctx.fill();
  }

  // === LOCATIONS ===
  // Fish Stand (left area)
  drawFishStand(ctx, worldW*0.18, gl);
  // Watering Hole
  drawWateringHole(ctx, worldW*0.65, gl);
  // Arena (right)
  drawArenaBuilding(ctx, worldW*0.82, gl);
  // Houses / Village (far left)
  drawHouse(ctx, houseX, gl, true);
  drawHouse(ctx, houseX+130, gl, false);
  // Blacksmith
  drawBlacksmith(ctx, worldW*0.45, gl);

  // Floating coins
  for(var ci=0;ci<floatCoins.length;ci++){
    var fc=floatCoins[ci];
    var cy2=fc.y+Math.sin(animFrame*0.07+ci)*8;
    ctx.fillStyle='#ffd700';
    ctx.font='20px serif';
    ctx.textAlign='center';
    ctx.fillText('ü™ô',fc.x,cy2);
  }

  // Dragon (before viking so viking is on top when walking)
  var drScreenY = groundLevel - drY - 30;
  var drScale = mode==='fly' ? 1.2 : 1.0;
  drawDragon(wctx, dragonData, drX+60, drScreenY+10, drScale, facing===1, mode==='fly', animFrame);

  // Viking character
  var vikingBob = (keys.left||keys.right)&&mode!=='fly' ? Math.sin(animFrame*0.3)*4 : 0;
  if(mode!=='fly') drawVikingOn(wctx, viking, drX, groundLevel-2+vikingBob, 0.9);

  // "Enter house" prompt
  if(nearHouse && mode!=='fly'){
    ctx.fillStyle='rgba(255,215,0,0.9)';
    ctx.font='14px Cinzel,Georgia';
    ctx.textAlign='center';
    ctx.fillText('‚ñº Tap Sleep to enter house', drX, groundLevel-80);
  }

  // Location labels
  drawLabel(ctx,'üêü Fish Stand', worldW*0.18, gl-115);
  drawLabel(ctx,'üíß Watering Hole', worldW*0.65, gl-85);
  drawLabel(ctx,'‚öîÔ∏è Arena', worldW*0.82, gl-150);
  drawLabel(ctx,'üèòÔ∏è Village', houseX+65, gl-165);
  drawLabel(ctx,'üî® Blacksmith', worldW*0.45, gl-110);
}

function drawLabel(ctx,text,x,y){
  ctx.fillStyle='rgba(0,0,0,0.55)';
  ctx.font='11px Cinzel,Georgia';
  ctx.textAlign='center';
  var w=ctx.measureText(text).width;
  ctx.beginPath(); ctx.roundRect(x-w/2-6,y-13,w+12,18,6); ctx.fill();
  ctx.fillStyle='#ffd700';
  ctx.fillText(text,x,y);
}

function drawCloud(ctx,x,y,scale){
  ctx.fillStyle='rgba(255,255,255,0.88)';
  ctx.save(); ctx.scale(scale,scale);
  ctx.beginPath(); ctx.ellipse(x/scale,y/scale,45,22,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse((x-28)/scale,(y+5)/scale,28,18,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse((x+25)/scale,(y+8)/scale,25,16,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawHouse(ctx,x,gl,isMain){
  var w=isMain?100:80, h=isMain?90:75;
  // Foundation
  ctx.fillStyle='#5a4a3a';
  ctx.fillRect(x-w/2-5,gl-10,w+10,12);
  // Walls (stone)
  ctx.fillStyle='#8a7a6a';
  ctx.fillRect(x-w/2,gl-h,w,h);
  // Wood planks texture
  ctx.strokeStyle='#6a5a4a'; ctx.lineWidth=1.5;
  for(var p=0;p<h;p+=14){
    ctx.beginPath(); ctx.moveTo(x-w/2,gl-h+p); ctx.lineTo(x+w/2,gl-h+p); ctx.stroke();
  }
  // Roof (dark wood triangle)
  ctx.fillStyle='#5a3a1a';
  ctx.beginPath(); ctx.moveTo(x-w/2-12,gl-h); ctx.lineTo(x,gl-h-50*(isMain?1:0.8)); ctx.lineTo(x+w/2+12,gl-h); ctx.fill();
  ctx.fillStyle='#3a2010';
  ctx.beginPath(); ctx.moveTo(x-w/2-8,gl-h-5); ctx.lineTo(x,gl-h-48*(isMain?1:0.8)); ctx.lineTo(x+w/2+8,gl-h-5); ctx.fill();
  // Door
  ctx.fillStyle='#3a2010';
  ctx.beginPath(); ctx.roundRect(x-14,gl-50,28,50,4); ctx.fill();
  ctx.fillStyle='#c8a000';
  ctx.beginPath(); ctx.arc(x+8,gl-25,3,0,Math.PI*2); ctx.fill();
  // Windows
  ctx.fillStyle='rgba(255,240,180,0.6)';
  ctx.beginPath(); ctx.roundRect(x-w/2+10,gl-h+20,22,20,3); ctx.fill();
  if(isMain){
    ctx.beginPath(); ctx.roundRect(x+w/2-32,gl-h+20,22,20,3); ctx.fill();
  }
  // Smoke from chimney
  ctx.fillStyle='#4a3a1a';
  ctx.fillRect(x+w/2-22,gl-h-30,14,35);
  ctx.fillStyle='rgba(200,200,200,0.4)';
  for(var s2=0;s2<3;s2++){
    var puffY=animFrame*0.3+s2*20;
    var puffX=Math.sin(puffY*0.1)*6;
    ctx.beginPath(); ctx.arc(x+w/2-15+puffX,(gl-h-40-(puffY%60))*1,6+s2*3,0,Math.PI*2); ctx.fill();
  }
}

function drawFishStand(ctx,x,gl){
  // Wooden stand
  ctx.fillStyle='#8b5e3c';
  ctx.fillRect(x-50,gl-80,100,10);
  ctx.fillRect(x-45,gl-70,8,70); ctx.fillRect(x+37,gl-70,8,70);
  // Canvas top
  ctx.fillStyle='#c8341a';
  ctx.beginPath(); ctx.moveTo(x-60,gl-80); ctx.lineTo(x,gl-100); ctx.lineTo(x+60,gl-80); ctx.fill();
  // Fish
  ctx.font='20px serif'; ctx.textAlign='center';
  ctx.fillText('üêü',x-20,gl-60);
  ctx.fillText('üêü',x+10,gl-55);
  ctx.fillText('üê†',x-5,gl-75);
}

function drawWateringHole(ctx,x,gl){
  // Water pool
  var wGrad=ctx.createRadialGradient(x,gl-10,5,x,gl-10,65);
  wGrad.addColorStop(0,'#4fc3f7'); wGrad.addColorStop(1,'#0277bd');
  ctx.fillStyle=wGrad;
  ctx.beginPath(); ctx.ellipse(x,gl-8,65,20,0,0,Math.PI*2); ctx.fill();
  // Shimmer
  ctx.fillStyle='rgba(255,255,255,0.4)';
  for(var w2=0;w2<4;w2++){
    var wx=x-40+w2*22+Math.sin(animFrame*0.07+w2)*5;
    ctx.beginPath(); ctx.ellipse(wx,gl-12,8,3,0,0,Math.PI*2); ctx.fill();
  }
  // Reeds
  ctx.fillStyle='#5a8a2a';
  for(var r=0;r<5;r++){
    var rx=x-50+r*24;
    ctx.fillRect(rx,gl-45,4,40);
    ctx.fillStyle='#8a5a1a';
    ctx.beginPath(); ctx.ellipse(rx+2,gl-48,4,8,0.2,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#5a8a2a';
  }
}

function drawArenaBuilding(ctx,x,gl){
  // Outer ring
  ctx.strokeStyle='#8a7a6a'; ctx.lineWidth=12;
  ctx.beginPath(); ctx.ellipse(x,gl-20,90,35,0,Math.PI,Math.PI*2); ctx.stroke();
  // Fence posts
  ctx.fillStyle='#6a5a3a'; ctx.lineWidth=2;
  for(var f=0;f<12;f++){
    var angle=Math.PI+f*(Math.PI/11);
    var fx=x+Math.cos(angle)*85, fy=gl-20+Math.sin(angle)*32;
    ctx.fillRect(fx-3,fy-20,6,20);
  }
  // Arena floor (sand)
  ctx.fillStyle='#c8a050';
  ctx.beginPath(); ctx.ellipse(x,gl-5,75,25,0,Math.PI,Math.PI*2); ctx.fill();
  // Target dummy
  ctx.fillStyle='#8b5e3c';
  ctx.fillRect(x-3,gl-55,6,40);
  ctx.fillStyle='#cc4444';
  ctx.beginPath(); ctx.arc(x,gl-58,12,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#ffd700'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(x,gl-58,8,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.arc(x,gl-58,4,0,Math.PI*2); ctx.stroke();
}

function drawBlacksmith(ctx,x,gl){
  // Building
  ctx.fillStyle='#6a5a4a';
  ctx.fillRect(x-40,gl-80,80,80);
  // Roof
  ctx.fillStyle='#3a2010';
  ctx.beginPath(); ctx.moveTo(x-50,gl-80); ctx.lineTo(x,gl-115); ctx.lineTo(x+50,gl-80); ctx.fill();
  // Door
  ctx.fillStyle='#2a1a0a';
  ctx.beginPath(); ctx.roundRect(x-14,gl-50,28,50,3); ctx.fill();
  // Anvil sign
  ctx.fillStyle='#ffd700';
  ctx.font='22px serif'; ctx.textAlign='center';
  ctx.fillText('‚öíÔ∏è',x,gl-90);
  // Forge glow
  ctx.fillStyle='rgba(255,120,0,0.25)';
  var fg=ctx.createRadialGradient(x,gl-30,2,x,gl-30,35);
  fg.addColorStop(0,'rgba(255,120,0,0.5)'); fg.addColorStop(1,'transparent');
  ctx.fillStyle=fg;
  ctx.beginPath(); ctx.arc(x,gl-30,35,0,Math.PI*2); ctx.fill();
}

function renderIndoor(ctx) {
  // Inside house
  var w=worldW, h=worldH;
  // Floor
  ctx.fillStyle='#6a4a2a';
  ctx.fillRect(0,h*0.65,w,h*0.35);
  // Floor planks
  ctx.strokeStyle='#4a3010'; ctx.lineWidth=2;
  for(var p=0;p<w;p+=60){ ctx.beginPath(); ctx.moveTo(p,h*0.65); ctx.lineTo(p,h); ctx.stroke(); }
  // Walls
  ctx.fillStyle='#8a6a4a';
  ctx.fillRect(0,0,w,h*0.65);
  // Ceiling beams
  ctx.fillStyle='#5a3a1a'; ctx.lineWidth=18;
  for(var b=0;b<4;b++){ ctx.fillRect(0,b*(h*0.15),w,14); }
  // Fireplace
  drawFireplace(ctx, w*0.15, h*0.65);
  // BED
  drawBed(ctx, w*0.6, h*0.65);
  // Window with outside view
  ctx.fillStyle='rgba(135,206,235,0.6)';
  ctx.beginPath(); ctx.roundRect(w*0.35,h*0.15,120,90,6); ctx.fill();
  ctx.strokeStyle='#8b5e3c'; ctx.lineWidth=6;
  ctx.strokeRect(w*0.35,h*0.15,120,90);
  ctx.strokeStyle='#8b5e3c'; ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(w*0.35+60,h*0.15); ctx.lineTo(w*0.35+60,h*0.15+90); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(w*0.35,h*0.15+45); ctx.lineTo(w*0.35+120,h*0.15+45); ctx.stroke();
  // Shelf
  ctx.fillStyle='#8b5e3c'; ctx.fillRect(w*0.25,h*0.35,150,12);
  ctx.font='22px serif'; ctx.textAlign='left';
  ctx.fillText('‚öîÔ∏èüõ°Ô∏èüè∫',w*0.27,h*0.35-4);
  // Viking + Dragon inside
  drawVikingOn(ctx, viking, w*0.45, h*0.65, 0.85);
  drawDragon(ctx, dragonData, w*0.52+60, h*0.65-20, 0.6, true, false, animFrame);
  // Exit prompt
  ctx.fillStyle='rgba(255,215,0,0.9)'; ctx.font='13px Cinzel,Georgia'; ctx.textAlign='center';
  ctx.fillText('Tap Sleep button to exit', w/2, h*0.12);
  // Night overlay inside
  if(isNight){ ctx.fillStyle='rgba(0,0,40,0.35)'; ctx.fillRect(0,0,w,h); }
}

function drawFireplace(ctx,x,y){
  ctx.fillStyle='#5a4a3a';
  ctx.fillRect(x-40,y-80,80,80);
  var fGrad=ctx.createRadialGradient(x,y-20,2,x,y-20,38);
  fGrad.addColorStop(0,'#ff8c00'); fGrad.addColorStop(0.5,'#ff4500'); fGrad.addColorStop(1,'rgba(255,0,0,0)');
  ctx.fillStyle=fGrad;
  ctx.beginPath(); ctx.ellipse(x,y-15,32,28,0,0,Math.PI*2); ctx.fill();
  ctx.font='28px serif'; ctx.textAlign='center';
  ctx.fillText('üî•',x,y-10);
}

function drawBed(ctx,x,y){
  // Bed frame
  ctx.fillStyle='#6a3a1a';
  ctx.fillRect(x-70,y-40,160,40);
  // Pillow
  ctx.fillStyle='#e8d8c0';
  ctx.beginPath(); ctx.roundRect(x-60,y-60,60,22,8); ctx.fill();
  // Blanket
  ctx.fillStyle='#3a6a8a';
  ctx.beginPath(); ctx.roundRect(x-60,y-42,140,20,4); ctx.fill();
  // Blanket pattern
  ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=1.5;
  for(var q=0;q<4;q++){ ctx.beginPath(); ctx.moveTo(x-50+q*30,y-42); ctx.lineTo(x-50+q*30,y-22); ctx.stroke(); }
  // Headboard
  ctx.fillStyle='#5a2a0a';
  ctx.beginPath(); ctx.roundRect(x-70,y-80,25,45,5); ctx.fill();
  ctx.font='20px serif'; ctx.textAlign='center';
  ctx.fillText('üõèÔ∏è',x+10,y-50);
}

// ============================================================
// GAMEPLAY FUNCTIONS
// ============================================================
function changeStat(s,a){
  stats[s]=Math.max(0,Math.min(100,stats[s]+a));
  document.getElementById('b-'+s).style.width=stats[s]+'%';
  if(s==='food'||s==='water'){stats.happy=Math.max(0,Math.min(100,(stats.food+stats.water)/2));document.getElementById('b-happy').style.width=stats.happy+'%';}
}
function updateCoins(){ document.getElementById('b-coins').style.width=(coins/MAX_COINS*100)+'%'; document.getElementById('coin-num').textContent=coins; }
function showFlash(txt){ var f=document.createElement('div'); f.className='cflash'; f.textContent=txt; document.body.appendChild(f); setTimeout(function(){f.remove();},1000); }

function spawnCoins(){
  floatCoins=[];
  for(var i=0;i<8;i++){
    floatCoins.push({x:80+Math.random()*(worldW-160), y:groundLevel-30-Math.random()*200});
  }
}

function feedDragon(){ if(stats.food>=100){showPopup('üêü Already Full!',dragonNickname+' is stuffed!','');return;} changeStat('food',25); showPopup('üêü Fish Stand!','You grabbed a huge bucket of fresh fish! '+dragonNickname+' gobbled them up in seconds and let out a happy roar!','<div class="outcome win">+25 Food! üêü</div>'); }
function waterDragon(){ if(stats.water>=100){showPopup('üíß Not Thirsty!',dragonNickname+' just had a drink!','');return;} changeStat('water',25); showPopup('üíß Watering Hole!',dragonNickname+' took a long refreshing drink from the sparkling watering hole surrounded by reeds!','<div class="outcome win">+25 Water! üíß</div>'); }

function toggleDayNight(){
  isNight=!isNight;
  document.getElementById('s-world').style.transition='background 2s';
  showFlash(isNight?'üåô Night falls...':'‚òÄÔ∏è Morning!');
}

function trySleep(){
  if(insideHouse){
    insideHouse=false;
    return;
  }
  if(!isNight && !nearHouse){
    showPopup('üåô Not Yet!','It is still daytime! Bring your dragon to the village house first, then sleep when night falls.','');
    return;
  }
  // Enter house or sleep
  insideHouse=true;
  if(isNight){
    // Sleep sequence
    sleepFade=1;
    setTimeout(function(){
      isNight=false; dayTime=0;
      changeStat('food',15); changeStat('water',15); changeStat('happy',20);
      coins=Math.min(MAX_COINS,coins+3);
      updateCoins();
      setTimeout(function(){
        insideHouse=false;
        sleepFade=0;
        showPopup('‚òÄÔ∏è Good Morning!','You slept soundly! '+viking.name+' and '+dragonNickname+' wake up refreshed and ready for adventure!','<div class="outcome win">+15 Food, +15 Water, +20 Happy, +3 ü™ô Coins!</div>');
      },2000);
    },3000);
  }
}

// ============================================================
// ARENA TRAINING
// ============================================================
var trainingMoves = [
  {name:'üî• Blast Training',      desc:'Fire at the target dummy!',  result:'BULLSEYE! The target explodes! Your dragon\'s accuracy increases!'},
  {name:'üí® Speed Dash',          desc:'Race across the arena at full speed!', result:'Incredible! Your dragon is a blur! Speed +5!'},
  {name:'üåÄ Aerial Spiral',       desc:'Fly in a tight corkscrew through the rings!', result:'Perfect form! The crowd cheers! Agility +5!'},
  {name:'üõ°Ô∏è Dodge Training',     desc:'Dodge incoming boulder throws!', result:'Flawless dodging! Reflexes sharpened!'},
  {name:'ü¶Ö Height Challenge',    desc:'Fly as high as possible then dive back!', result:'Breathtaking! Record altitude achieved!'},
  {name:'üéØ Precision Strike',    desc:'Hit all 5 tiny targets in sequence!', result:'All 5 targets hit! Precision master!'},
];

function openArena(){
  var btns = trainingMoves.map(function(m){
    return '<button class="arena-btn" onclick="doTraining(\''+m.name.replace(/'/g,'')+'\',\''+m.result.replace(/'/g,'')+'\')">' + m.name + '<br><span style="font-size:0.75em;color:#aad4ff">'+m.desc+'</span></button>';
  }).join('');
  showPopup('üèãÔ∏è Training Arena', 'Choose a training exercise for '+dragonNickname+'!',
    '<div class="arena-btns">'+btns+'</div>');
}

function doTraining(name, result){
  changeStat('happy',8); coins=Math.min(MAX_COINS,coins+1); updateCoins();
  showPopup(name, result, '<div class="outcome win">Training complete! +Happy, +1 ü™ô</div>');
}

// ============================================================
// BATTLE
// ============================================================
var enemies = [
  {name:'Red Death',    emoji:'üî¥', hp:100, atks:['Lava Breath','Tail Smash','Wing Gust','Boulder Throw'], weak:'belly'},
  {name:'Bewilderbeast',emoji:'‚ùÑÔ∏è', hp:100, atks:['Ice Blast','Tidal Wave','Roar','Stomp'], weak:'eyes'},
  {name:'Dragon Hunter',emoji:'üè¥‚Äç‚ò†Ô∏è',hp:100, atks:['Net Throw','Crossbow','Smoke Bomb','Trap'], weak:'equipment'},
  {name:'Green Death',  emoji:'üü¢', hp:100, atks:['Acid Spray','Tail Whip','Belly Flop','Charge'], weak:'horns'},
];
var battleState = null;

function openBattle(){
  var html='<p style="color:#e0d0b0;margin-bottom:10px">Choose your enemy:</p><div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">';
  enemies.forEach(function(e,i){
    html+='<button class="arena-btn" onclick="startBattle('+i+')" style="min-width:100px;">'+e.emoji+'<br><span style="font-family:Cinzel;font-size:0.8em">'+e.name+'</span></button>';
  });
  html+='</div>';
  showPopup('‚öîÔ∏è Choose Your Enemy','',html);
}

function startBattle(idx){
  var enemy = JSON.parse(JSON.stringify(enemies[idx]));
  battleState = {enemy:enemy, playerHP:100, turn:0};
  renderBattle();
}

function renderBattle(){
  if(!battleState) return;
  var b=battleState;
  var eatk = b.enemy.atks[Math.floor(Math.random()*b.enemy.atks.length)];
  var html =
    '<div class="hp-row">' +
    '<div class="hp-box"><div class="hp-label">'+viking.name+' & '+dragonNickname+'</div><div class="hp-bar"><div class="hp-fill" style="width:'+b.playerHP+'%;background:linear-gradient(90deg,#27ae60,#2ecc71)"></div></div><div style="font-size:0.75em;color:#aad4ff">'+b.playerHP+'/100</div></div>' +
    '<div class="hp-box"><div class="hp-label">'+b.enemy.name+'</div><div class="hp-bar"><div class="hp-fill" style="width:'+b.enemy.hp+'%"></div></div><div style="font-size:0.75em;color:#aad4ff">'+b.enemy.hp+'/100</div></div>' +
    '</div>' +
    '<div class="enemy-face">'+b.enemy.emoji+'</div>' +
    '<p style="color:#aad4ff;font-size:0.8em;margin-bottom:8px">'+b.enemy.name+' prepares to use: <strong style="color:#e74c3c">'+eatk+'</strong></p>' +
    '<p style="color:#ffd700;font-family:Cinzel;font-size:0.82em;margin-bottom:6px">Choose your attack:</p>' +
    '<div class="arena-btns" style="gap:6px;">' +
    '<button class="arena-btn" onclick="battleAttack(\'blast\',\''+eatk+'\')">üî• Fire Blast<br><span style="font-size:0.72em;color:#aad4ff">Big damage</span></button>' +
    '<button class="arena-btn" onclick="battleAttack(\'dodge\',\''+eatk+'\')">üí® Dodge+Strike<br><span style="font-size:0.72em;color:#aad4ff">Risky, high reward</span></button>' +
    '<button class="arena-btn" onclick="battleAttack(\'weak\',\''+eatk+'\')">üéØ Hit Weak Spot<br><span style="font-size:0.72em;color:#aad4ff">Aim for '+b.enemy.weak+'</span></button>' +
    '<button class="arena-btn" onclick="battleAttack(\'shield\',\''+eatk+'\')">üõ°Ô∏è Defend<br><span style="font-size:0.72em;color:#aad4ff">Reduce damage</span></button>' +
    '</div>';
  document.getElementById('pbody').innerHTML=html;
  document.getElementById('ptitle').textContent='‚öîÔ∏è Battle: '+b.enemy.name+'!';
  document.querySelector('.cbtn').textContent='Flee ‚úï';
  document.querySelector('.cbtn').onclick=function(){battleState=null;closePopup();};
}

function battleAttack(type, enemyAtk){
  var b=battleState;
  var playerDmg, enemyDmg, msg;
  if(type==='blast'){   playerDmg=Math.floor(18+Math.random()*14); enemyDmg=Math.floor(8+Math.random()*12); msg='üî• '+dragonNickname+' fires a huge blast for '+playerDmg+' damage!'; }
  else if(type==='dodge'){ var hit=Math.random()>0.35; playerDmg=hit?Math.floor(28+Math.random()*22):0; enemyDmg=hit?2:Math.floor(15+Math.random()*10); msg=hit?'üí® Perfect dodge! Counter strike for '+playerDmg+' damage!':'üí® Missed the dodge! Took '+enemyDmg+' damage!'; }
  else if(type==='weak'){ var crit=Math.random()>0.4; playerDmg=crit?Math.floor(30+Math.random()*20):Math.floor(10+Math.random()*8); enemyDmg=crit?0:Math.floor(8+Math.random()*8); msg=crit?'üéØ CRITICAL HIT on the '+b.enemy.weak+'! '+playerDmg+' massive damage!':'üéØ Missed the weak spot... '+playerDmg+' damage and took '+enemyDmg+'.'; }
  else{ playerDmg=Math.floor(6+Math.random()*8); enemyDmg=Math.floor(3+Math.random()*6); msg='üõ°Ô∏è Defended well! Only '+enemyDmg+' damage taken, and dealt '+playerDmg+'.'; }

  b.enemy.hp=Math.max(0,b.enemy.hp-playerDmg);
  b.playerHP=Math.max(0,b.playerHP-enemyDmg);
  b.turn++;

  if(b.enemy.hp<=0){
    battleState=null;
    var reward=Math.floor(8+Math.random()*7);
    coins=Math.min(MAX_COINS,coins+reward); updateCoins(); changeStat('happy',15);
    showPopup('üèÜ VICTORY!','You defeated the '+b.enemy.name+'! '+dragonNickname+' roars triumphantly and the crowd goes WILD!','<div class="outcome win">+'+reward+' ü™ô Coins! +15 Happy!</div>');
    return;
  }
  if(b.playerHP<=0){
    battleState=null;
    showPopup('üíî Defeated...','The '+b.enemy.name+' was too powerful this time. But '+dragonNickname+' fought bravely! Train harder and try again!','<div class="outcome lose">Retreat to Berk...</div>');
    return;
  }
  // Continue
  var html2='<div style="background:rgba(255,255,255,0.06);border-radius:10px;padding:10px;margin-bottom:10px;color:#e0d0b0;font-size:0.88em;line-height:1.6">'+msg+'<br><em style="color:#e74c3c">'+b.enemy.name+' used '+enemyAtk+'!</em></div>';
  document.getElementById('pbody').innerHTML=html2;
  document.getElementById('ptitle').textContent='Round '+(b.turn+1)+'...';
  setTimeout(renderBattle,1200);
}

// ============================================================
// SHOP
// ============================================================
function openShop(){
  var html='<div class="cdsp">You have '+coins+' ü™ô coins</div><div class="shop-grid">';
  saddles.forEach(function(s){
    var own=ownedSaddles.indexOf(s.id)!==-1;
    html+='<div class="si'+(own?' own':'')+'"'+(own?'':' onclick="buySaddle(\''+s.id+'\',\''+s.name+'\','+s.price+')"')+'>'+
      '<div class="si-e">'+s.emoji+'</div>'+
      '<div class="si-n">'+s.name+'</div>'+
      '<div class="si-p">'+(own?'<span class="own-tag">‚úÖ Owned!</span>':'ü™ô '+s.price+' coins')+'</div>'+
      '<div style="font-size:0.68em;color:#aad4ff;margin-top:2px">'+s.desc+'</div>'+
      '</div>';
  });
  html+='</div>';
  showPopup('üî® Blacksmith Shop','',html);
}
function buySaddle(id,name,price){
  if(coins<price){ showFlash('Need more coins!'); return; }
  coins-=price; ownedSaddles.push(id); updateCoins();
  showPopup('üéâ New Saddle!','You bought the '+name+'! '+dragonNickname+' looks absolutely magnificent in it!','<div class="outcome win">Purchase complete! üõí</div>');
}

// ============================================================
// GAMES
// ============================================================
function openGameMenu(){ showPopup('üéÆ Games','Which game do you want to play with '+dragonNickname+'?','<div style="display:flex;gap:9px;justify-content:center;flex-wrap:wrap;"><button class="gcbtn" onclick="startTTT()">‚≠ï Tic Tac Toe</button><button class="gcbtn" onclick="startCards()">üÉè Card Match</button><button class="gcbtn" onclick="startSoccer()">‚öΩ Dragon Soccer</button></div>'); }

var tB,tT,tO;
function startTTT(){ tB=Array(9).fill(''); tT='X'; tO=true; drawTTT(); }
function drawTTT(){
  var c=''; for(var i=0;i<9;i++) c+='<div class="tttc" onclick="tc('+i+')">'+(tB[i]==='X'?'üî•':tB[i]==='O'?dragonData.emoji:'')+'</div>';
  document.getElementById('pbody').innerHTML='<p style="color:#aad4ff;margin-bottom:6px">'+(tO?(tT==='X'?'Your turn üî•':dragonNickname+'\'s turn'):'Game Over!')+'</p><div class="ttt-board">'+c+'</div><button class="gcbtn" style="margin-top:8px" onclick="startTTT()">New</button><button class="gcbtn" style="margin-top:8px" onclick="openGameMenu()">Back</button>';
}
function tc(i){ if(!tO||tB[i]) return; tB[i]=tT; var w=cTTT(); if(w){tO=false;drawTTT();addTR(w);return;} if(tB.indexOf('')===-1){tO=false;drawTTT();addTR('draw');return;} tT=tT==='X'?'O':'X'; drawTTT(); if(tT==='O') setTimeout(aiT,600); }
function aiT(){ if(!tO) return; var e=[]; for(var i=0;i<9;i++){if(!tB[i])e.push(i);} if(!e.length) return; tB[e[Math.floor(Math.random()*e.length)]]='O'; var w=cTTT(); if(w){tO=false;drawTTT();addTR(w);return;} if(tB.indexOf('')===-1){tO=false;drawTTT();addTR('draw');return;} tT='X';drawTTT(); }
function cTTT(){ var L=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; for(var i=0;i<L.length;i++){var a=L[i][0],b=L[i][1],c3=L[i][2];if(tB[a]&&tB[a]===tB[b]&&tB[a]===tB[c3])return tB[a];} return null; }
function addTR(w){ var m=w==='draw'?'Draw! '+dragonNickname+' roars respectfully!':w==='X'?'üéâ You win!':dragonNickname+' wins! üî•'; document.getElementById('pbody').innerHTML+='<div class="outcome '+(w==='X'?'win':w==='draw'?'':'lose')+'" style="margin-top:7px">'+m+'</div>'; }

var cC2,cF2,cM2,cCF2,cSym=['üêâ','‚ö°','üî•','‚ùÑÔ∏è','üí®','‚ú®'];
function startCards(){ var d2=cSym.concat(cSym).sort(function(){return Math.random()-0.5;}); cC2=d2.map(function(s,i){return{id:i,s:s,shown:false,matched:false};}); cF2=[];cM2=0;cCF2=true;drawCards2(); }
function drawCards2(){ var h='<p style="color:#aad4ff;margin-bottom:6px">Match all pairs! '+cM2+'/'+cSym.length+'</p><div class="card-area">'; for(var i=0;i<cC2.length;i++){var c4=cC2[i];h+='<div class="card'+(c4.shown||c4.matched?' flip':'')+'" onclick="fc2('+i+')">'+(c4.shown||c4.matched?c4.s:'üê≤')+'</div>';} h+='</div><button class="gcbtn" style="margin-top:8px" onclick="startCards()">New</button><button class="gcbtn" style="margin-top:8px" onclick="openGameMenu()">Back</button>'; document.getElementById('pbody').innerHTML=h; }
function fc2(i){ if(!cCF2||cC2[i].shown||cC2[i].matched) return; cC2[i].shown=true;cF2.push(i);drawCards2(); if(cF2.length===2){cCF2=false;setTimeout(function(){var a=cF2[0],b2=cF2[1];if(cC2[a].s===cC2[b2].s){cC2[a].matched=cC2[b2].matched=true;cM2++;}cC2[a].shown=cC2[b2].shown=false;cF2=[];cCF2=true;drawCards2();if(cM2===cSym.length)document.getElementById('pbody').innerHTML+='<div class="outcome win">üéâ All matched! '+dragonNickname+' is so proud!</div>';},800);} }

var sS2,sG2,sO2;
function startSoccer(){ sS2=0;sG2=0;sO2=true;drawSoc(''); }
function drawSoc(msg){ document.getElementById('pbody').innerHTML='<p style="color:#ffd700;margin-bottom:5px">‚öΩ Dragon Soccer! Score 3 to win!</p><p style="color:#aad4ff;font-size:0.82em;margin-bottom:7px">Shots: '+sS2+' | Goals: '+sG2+'/3</p><div class="goal-box"><div id="gfb" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.7em"></div></div><div class="aim-row"><button class="aim-btn" onclick="sh(\'left\')">‚ÜñÔ∏è Left</button><button class="aim-btn" onclick="sh(\'center\')">‚¨ÜÔ∏è Center</button><button class="aim-btn" onclick="sh(\'right\')">‚ÜóÔ∏è Right</button></div>'+(msg?'<p style="margin-top:7px;font-weight:700;color:'+(msg.indexOf('GOAL')!==-1?'#2ecc71':'#e74c3c')+'">'+msg+'</p>':'')+'<button class="gcbtn" style="margin-top:8px" onclick="startSoccer()">New</button><button class="gcbtn" style="margin-top:8px" onclick="openGameMenu()">Back</button>'; }
function sh(dir){ if(!sO2) return; sS2++; var g=['left','center','right'][Math.floor(Math.random()*3)]; var s=dir!==g; if(s)sG2++; var fb=document.getElementById('gfb'); if(fb)fb.textContent=s?'‚öΩ':'üß§'; if(sG2>=3){sO2=false;document.getElementById('pbody').innerHTML='<div class="outcome win" style="font-size:1em;margin:10px 0">üèÜ 3 goals in '+sS2+' shots!<br>'+dragonNickname+' does a victory lap!</div><button class="gcbtn" onclick="startSoccer()">Again</button><button class="gcbtn" onclick="openGameMenu()">Back</button>';return;} drawSoc(s?'GOAL! üî•':'Saved! Try again!'); }

// ============================================================
// POPUP / CONTROLS
// ============================================================
function showPopup(title,text,extra){ document.getElementById('ptitle').textContent=title; document.getElementById('pbody').innerHTML=(text?'<div class="pop-text">'+text+'</div>':'')+(extra||''); document.querySelector('.cbtn').textContent='Close ‚úï'; document.querySelector('.cbtn').onclick=closePopup; document.getElementById('popup').classList.add('open'); }
function closePopup(){ document.getElementById('popup').classList.remove('open'); battleState=null; }

function setMode(m){
  mode=m;
  document.querySelectorAll('.mbtn').forEach(function(b){b.classList.remove('am');});
  document.getElementById('mb-'+m).classList.add('am');
  var badge=document.getElementById('mode-badge');
  if(m==='walk'){badge.textContent='üö∂ Walking';}
  else if(m==='run'){badge.textContent='üí® Running!';}
  else {badge.textContent='ü¶Ö Flying!'; drY=0;}
}

function dk(dir,on){
  keys[dir]=on;
  var el=document.getElementById('btn-'+dir);
  // d-pad buttons don't have separate IDs in this version, skip visual
}

document.addEventListener('keydown',function(e){
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=1;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=1;
  if(e.key==='ArrowUp'||e.key==='w') keys.up=1;
  if(e.key==='ArrowDown'||e.key==='s') keys.down=1;
  if(e.key==='1') setMode('walk');
  if(e.key==='2') setMode('run');
  if(e.key==='3') setMode('fly');
});
document.addEventListener('keyup',function(e){
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=0;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=0;
  if(e.key==='ArrowUp'||e.key==='w') keys.up=0;
  if(e.key==='ArrowDown'||e.key==='s') keys.down=0;
});
</script>

</body>
</html>
