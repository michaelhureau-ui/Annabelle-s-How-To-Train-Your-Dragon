<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dragon World</title>
<style>
* { box-sizing:border-box; margin:0; padding:0; user-select:none; }
body { font-family:Georgia,serif; background:#1a3a1a; color:white; overflow:hidden; }
.screen { display:none; }
.screen.active { display:block; }

/* ‚Äì‚Äì CHOOSE SCREEN ‚Äì‚Äì */
#s-choose { background:linear-gradient(135deg,#0a0a2e,#1a1a4e,#0d2137); min-height:100vh; padding:20px; overflow-y:auto; }
h1 { text-align:center; font-size:2em; color:#ffd700; text-shadow:0 0 20px #ff6600; margin-bottom:5px; }
.subtitle { text-align:center; color:#aad4ff; margin-bottom:20px; }
.section-title { text-align:center; color:#ffd700; font-size:1.2em; margin-bottom:15px; }
.dragon-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; max-width:680px; margin:0 auto 20px; }
.dragon-card { background:rgba(255,255,255,0.08); border:2px solid rgba(255,255,255,0.2); border-radius:15px; padding:12px; text-align:center; cursor:pointer; transition:all 0.3s; }
.dragon-card:hover,.dragon-card.selected { border-color:#ffd700; background:rgba(255,215,0,0.2); transform:scale(1.05); }
.d-emoji { font-size:2.5em; }
.d-name { font-weight:bold; color:#ffd700; margin:4px 0 2px; font-size:0.9em; }
.d-type { font-size:0.7em; color:#aad4ff; }
.cbox { background:rgba(255,255,255,0.08); border-radius:20px; padding:20px; max-width:460px; margin:0 auto; }
.cbox label { display:block; margin:10px 0 4px; color:#ffd700; font-weight:bold; }
.cbox input { width:100%; padding:9px; border-radius:10px; border:2px solid rgba(255,215,0,0.4); background:rgba(0,0,0,0.3); color:white; font-size:1em; }
.color-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:5px; }
.cbtn { width:32px; height:32px; border-radius:50%; border:3px solid transparent; cursor:pointer; transition:transform 0.2s; }
.cbtn.selected { border-color:white; transform:scale(1.2); }
.power-row { display:flex; gap:7px; flex-wrap:wrap; margin-top:5px; }
.pbtn { padding:6px 12px; border-radius:20px; border:2px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:white; cursor:pointer; font-size:0.8em; }
.pbtn.selected { background:rgba(255,215,0,0.3); border-color:#ffd700; color:#ffd700; }
.big-btn { display:block; margin:15px auto 0; padding:13px 30px; border-radius:15px; border:none; background:linear-gradient(135deg,#ffd700,#ff8c00); color:#1a1a1a; font-size:1.05em; font-weight:bold; cursor:pointer; }
.big-btn:hover { transform:scale(1.05); }

/* ‚Äì‚Äì WORLD SCREEN ‚Äì‚Äì */
#s-world { width:100vw; height:100vh; position:relative; overflow:hidden; }

/* SKY */
#sky { position:absolute; top:0; left:0; right:0; height:55%; background:linear-gradient(180deg,#3a9bd5 0%,#87CEEB 70%,#b8e0f7 100%); transition:background 0.5s; }

/* GROUND */
#ground { position:absolute; bottom:0; left:0; right:0; height:48%; background:linear-gradient(180deg,#4a7c3f 0%,#2d5a1b 40%,#1a3a0a 100%); }

/* HORIZON LINE */
#horizon { position:absolute; top:52%; left:0; right:0; height:8px; background:linear-gradient(90deg,#3a6b2a,#5a8f40,#3a6b2a); }

/* SCROLLING GROUND LAYER */
#scroll-layer { position:absolute; bottom:0; left:0; width:300%; height:50%; }

/* CLOUDS */
.cloud { position:absolute; background:white; border-radius:40px; opacity:0.9; }

/* LOCATIONS as scenery */
.scenery { position:absolute; text-align:center; }
.scenery-icon { font-size:3em; display:block; filter:drop-shadow(0 4px 8px rgba(0,0,0,0.4)); }
.scenery-label { font-size:0.65em; font-weight:bold; color:white; text-shadow:0 1px 4px black; background:rgba(0,0,0,0.5); border-radius:8px; padding:2px 6px; display:block; margin-top:2px; cursor:pointer; }
.scenery-label:hover { background:rgba(255,215,0,0.4); }

/* DRAGON */
#dragon-wrap { position:absolute; transition:bottom 0.3s ease; z-index:20; }
#dragon-sprite { font-size:4em; display:block; line-height:1; transition:transform 0.1s; }
#dragon-shadow { width:60px; height:12px; background:rgba(0,0,0,0.25); border-radius:50%; margin:0 auto; transition:all 0.3s; }

/* MODE INDICATOR */
#mode-badge { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); border:2px solid rgba(255,215,0,0.5); border-radius:20px; padding:6px 18px; font-size:1em; font-weight:bold; color:#ffd700; z-index:30; }

/* HUD */
#hud { position:absolute; top:10px; left:10px; right:10px; z-index:30; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; pointer-events:none; }
.hud-card { background:rgba(0,0,0,0.65); border:1px solid rgba(255,215,0,0.4); border-radius:12px; padding:7px 11px; pointer-events:all; }
.hud-name { color:#ffd700; font-weight:bold; font-size:0.85em; }
.stat-row { display:flex; align-items:center; gap:5px; margin-top:3px; }
.stat-label { font-size:0.68em; color:#aad4ff; width:52px; }
.stat-bar { width:70px; height:9px; background:rgba(255,255,255,0.2); border-radius:5px; overflow:hidden; }
.stat-fill { height:100%; border-radius:5px; transition:width 0.5s; }
.fill-food  { background:linear-gradient(90deg,#ff6b35,#ffd700); }
.fill-water { background:linear-gradient(90deg,#4fc3f7,#0288d1); }
.fill-happy { background:linear-gradient(90deg,#f06292,#e91e63); }
.fill-coins { background:linear-gradient(90deg,#ffd700,#ff8c00); }

/* FLOATING COINS */
.floating-coin { position:absolute; font-size:1.6em; cursor:pointer; z-index:15; animation:coinbob 1.5s ease-in-out infinite; filter:drop-shadow(0 0 6px #ffd700); }
.floating-coin:hover { transform:scale(1.3); }
@keyframes coinbob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
.coin-flash { position:fixed; top:40%; left:50%; transform:translateX(-50%); font-size:1.4em; color:#ffd700; font-weight:bold; z-index:999; pointer-events:none; animation:flashup 1s ease forwards; }
@keyframes flashup { 0%{opacity:1;top:40%} 100%{opacity:0;top:25%} }

/* BOTTOM CONTROLS */
#controls { position:absolute; bottom:0; left:0; right:0; z-index:30; display:flex; justify-content:space-between; align-items:flex-end; padding:12px 16px 16px; pointer-events:none; }

/* D-PAD */
#dpad { display:grid; grid-template-columns:repeat(3,44px); grid-template-rows:repeat(3,44px); gap:4px; pointer-events:all; }
.dpad-btn { background:rgba(0,0,0,0.7); border:2px solid rgba(255,255,255,0.3); border-radius:10px; font-size:1.2em; display:flex; align-items:center; justify-content:center; cursor:pointer; color:white; transition:background 0.1s; touch-action:none; -webkit-tap-highlight-color:transparent; }
.dpad-btn:active, .dpad-btn.pressed { background:rgba(255,215,0,0.4); border-color:#ffd700; }
.dpad-center { background:rgba(255,255,255,0.05); border-color:transparent; cursor:default; }

/* MODE BUTTONS */
#mode-btns { display:flex; flex-direction:column; gap:8px; align-items:flex-end; pointer-events:all; }
.mode-btn { padding:10px 18px; border-radius:12px; border:2px solid rgba(255,255,255,0.3); font-size:0.9em; font-weight:bold; cursor:pointer; color:white; transition:all 0.2s; min-width:90px; }
.mode-btn.active-mode { border-color:#ffd700; transform:scale(1.08); }
#btn-walk { background:linear-gradient(135deg,#27ae60,#1e8449); }
#btn-run  { background:linear-gradient(135deg,#e67e22,#d35400); }
#btn-fly  { background:linear-gradient(135deg,#2980b9,#1a5276); }

/* ACTION BUTTONS ROW */
#action-bar { position:absolute; bottom:0; left:50%; transform:translateX(-50%); z-index:30; display:flex; gap:7px; padding-bottom:14px; pointer-events:all; }
.abtn { padding:9px 12px; border-radius:11px; border:none; font-size:0.75em; font-weight:bold; cursor:pointer; color:white; white-space:nowrap; }
.btn-feed   { background:linear-gradient(135deg,#e67e22,#d35400); }
.btn-water  { background:linear-gradient(135deg,#2980b9,#1a5276); }
.btn-quest  { background:linear-gradient(135deg,#8e44ad,#6c3483); }
.btn-rescue { background:linear-gradient(135deg,#c0392b,#922b21); }
.btn-battle { background:linear-gradient(135deg,#d35400,#a04000); }
.btn-game   { background:linear-gradient(135deg,#16a085,#1abc9c); }
.btn-shop   { background:linear-gradient(135deg,#f39c12,#d68910); }

/* POPUP */
.popup-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.78); z-index:100; display:none; align-items:center; justify-content:center; padding:16px; }
.popup-overlay.open { display:flex; }
.popup { background:linear-gradient(135deg,#1a2a1a,#0d1a0d); border:2px solid rgba(255,215,0,0.5); border-radius:20px; padding:22px; max-width:500px; width:100%; max-height:88vh; overflow-y:auto; text-align:center; }
.popup-title { font-size:1.2em; color:#ffd700; margin-bottom:10px; }
.popup-text { line-height:1.7; color:#e0e0e0; margin-bottom:10px; }
.outcome { font-size:1em; font-weight:bold; margin-top:8px; }
.win { color:#2ecc71; } .lose { color:#e74c3c; }
.close-btn { padding:9px 22px; border-radius:12px; border:none; background:linear-gradient(135deg,#ffd700,#ff8c00); color:#1a1a1a; font-weight:bold; cursor:pointer; margin-top:10px; }
.game-choice { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:10px; }
.gcbtn { padding:10px 15px; border-radius:14px; border:2px solid rgba(255,215,0,0.4); background:rgba(255,215,0,0.1); color:#ffd700; font-size:0.9em; cursor:pointer; }
.gcbtn:hover { background:rgba(255,215,0,0.25); }
.ttt-board { display:grid; grid-template-columns:repeat(3,1fr); gap:7px; max-width:220px; margin:8px auto; }
.ttt-cell { height:65px; background:rgba(255,255,255,0.1); border:2px solid rgba(255,215,0,0.3); border-radius:10px; font-size:2em; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.ttt-cell:hover { background:rgba(255,215,0,0.15); }
.card-area { display:flex; gap:9px; justify-content:center; flex-wrap:wrap; margin:8px 0; }
.card { width:60px; height:88px; border-radius:10px; border:2px solid #ffd700; background:linear-gradient(135deg,#1a3a6e,#0d2137); font-size:1.8em; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.2s; }
.card:hover { transform:scale(1.1) translateY(-4px); }
.card.flipped { background:linear-gradient(135deg,#2d5a1b,#1a3a0a); }
.aim-row { display:flex; gap:8px; justify-content:center; margin:8px 0; }
.aim-btn { padding:7px 14px; border-radius:10px; border:2px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:white; cursor:pointer; font-size:0.9em; }
.aim-btn:hover { background:rgba(255,215,0,0.2); border-color:#ffd700; }
.goal-box { width:110px; height:65px; border:4px solid white; border-bottom:none; margin:0 auto 8px; border-radius:5px 5px 0 0; position:relative; background:rgba(255,255,255,0.05); }
.shop-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(125px,1fr)); gap:9px; margin:8px 0; }
.shop-item { background:rgba(255,255,255,0.08); border:2px solid rgba(255,215,0,0.3); border-radius:14px; padding:11px; text-align:center; cursor:pointer; transition:all 0.2s; }
.shop-item:hover { border-color:#ffd700; background:rgba(255,215,0,0.15); transform:scale(1.04); }
.shop-item.owned { border-color:#2ecc71; background:rgba(46,204,113,0.12); cursor:default; }
.shop-item.owned:hover { transform:none; }
.s-emoji { font-size:1.9em; margin-bottom:3px; }
.s-name { font-weight:bold; color:#ffd700; font-size:0.82em; }
.s-price { color:#aad4ff; font-size:0.74em; margin-top:2px; }
.owned-tag { color:#2ecc71; font-size:0.74em; font-weight:bold; }
.coin-disp { color:#ffd700; font-size:1em; font-weight:bold; margin-bottom:10px; }
</style>

</head>
<body>

<!-- CHOOSE SCREEN -->

<div id="s-choose" class="screen active">
  <h1>üêâ Dragon World</h1>
  <p class="subtitle">How to Train Your Dragon</p>
  <p class="section-title">Choose Your Dragon!</p>
  <div class="dragon-grid">
    <div class="dragon-card" onclick="pick(this,'Toothless','Night Fury','üêâ')"><div class="d-emoji">üêâ</div><div class="d-name">Toothless</div><div class="d-type">Night Fury</div></div>
    <div class="dragon-card" onclick="pick(this,'Light Fury','Light Fury','ü§ç')"><div class="d-emoji">ü§ç</div><div class="d-name">Light Fury</div><div class="d-type">Light Fury</div></div>
    <div class="dragon-card" onclick="pick(this,'Stormfly','Deadly Nadder','üíô')"><div class="d-emoji">üíô</div><div class="d-name">Stormfly</div><div class="d-type">Deadly Nadder</div></div>
    <div class="dragon-card" onclick="pick(this,'Hookfang','Monstrous Nightmare','üî•')"><div class="d-emoji">üî•</div><div class="d-name">Hookfang</div><div class="d-type">Monstrous Nightmare</div></div>
    <div class="dragon-card" onclick="pick(this,'Meatlug','Gronckle','ü™®')"><div class="d-emoji">ü™®</div><div class="d-name">Meatlug</div><div class="d-type">Gronckle</div></div>
    <div class="dragon-card" onclick="pick(this,'Barf and Belch','Hideous Zippleback','üíö')"><div class="d-emoji">üíö</div><div class="d-name">Barf &amp; Belch</div><div class="d-type">Hideous Zippleback</div></div>
    <div class="dragon-card" onclick="pick(this,'Cloudjumper','Stormcutter','‚ö°')"><div class="d-emoji">‚ö°</div><div class="d-name">Cloudjumper</div><div class="d-type">Stormcutter</div></div>
    <div class="dragon-card" onclick="pick(this,'Skullcrusher','Rumblehorn','üíú')"><div class="d-emoji">üíú</div><div class="d-name">Skullcrusher</div><div class="d-type">Rumblehorn</div></div>
  </div>
  <p class="section-title">Customize!</p>
  <div class="cbox">
    <label>Nickname:</label>
    <input type="text" id="nickname" placeholder="e.g. Sparkles, Blaze, Shadow...">
    <label>Color:</label>
    <div class="color-row">
      <div class="cbtn selected" style="background:#111" onclick="pickColor(this,'Midnight Black')"></div>
      <div class="cbtn" style="background:#e74c3c" onclick="pickColor(this,'Fire Red')"></div>
      <div class="cbtn" style="background:#3498db" onclick="pickColor(this,'Ocean Blue')"></div>
      <div class="cbtn" style="background:#2ecc71" onclick="pickColor(this,'Forest Green')"></div>
      <div class="cbtn" style="background:#9b59b6" onclick="pickColor(this,'Royal Purple')"></div>
      <div class="cbtn" style="background:#ffd700" onclick="pickColor(this,'Golden Yellow')"></div>
      <div class="cbtn" style="background:#fff" onclick="pickColor(this,'Pearly White')"></div>
      <div class="cbtn" style="background:#ff69b4" onclick="pickColor(this,'Hot Pink')"></div>
    </div>
    <label>Special Power:</label>
    <div class="power-row">
      <button class="pbtn selected" onclick="pickPower(this,'Plasma Blast')">üî• Plasma Blast</button>
      <button class="pbtn" onclick="pickPower(this,'Lightning Strike')">‚ö° Lightning Strike</button>
      <button class="pbtn" onclick="pickPower(this,'Ice Breath')">‚ùÑÔ∏è Ice Breath</button>
      <button class="pbtn" onclick="pickPower(this,'Tornado Spin')">üí® Tornado Spin</button>
      <button class="pbtn" onclick="pickPower(this,'Magic Shield')">‚ú® Magic Shield</button>
    </div>
  </div>
  <button class="big-btn" onclick="startWorld()">Enter Dragon World! üåç</button>
</div>

<!-- WORLD SCREEN -->

<div id="s-world" class="screen">
  <!-- Sky + Ground -->
  <div id="sky"></div>
  <div id="horizon"></div>
  <div id="ground"></div>

  <!-- Clouds -->

  <div id="cloud1" class="cloud" style="width:110px;height:38px;top:8%;left:10%;"></div>
  <div id="cloud2" class="cloud" style="width:80px;height:28px;top:14%;left:55%;"></div>
  <div id="cloud3" class="cloud" style="width:130px;height:42px;top:6%;left:75%;"></div>

  <!-- Scenery objects -->

  <div class="scenery" id="scen-village" style="bottom:47%;left:8%">
    <span class="scenery-icon">üèòÔ∏è</span>
    <span class="scenery-label" onclick="visitLoc('village')">Village</span>
  </div>
  <div class="scenery" id="scen-fish" style="bottom:46%;left:28%">
    <span class="scenery-icon">üêü</span>
    <span class="scenery-label" onclick="feedDragon()">Fish Stand</span>
  </div>
  <div class="scenery" id="scen-smith" style="bottom:47%;left:50%">
    <span class="scenery-icon">üî®</span>
    <span class="scenery-label" onclick="openShop()">Blacksmith</span>
  </div>
  <div class="scenery" id="scen-water" style="bottom:46%;left:68%">
    <span class="scenery-icon">üíß</span>
    <span class="scenery-label" onclick="waterDragon()">Watering Hole</span>
  </div>
  <div class="scenery" id="scen-arena" style="bottom:47%;right:6%">
    <span class="scenery-icon">‚öîÔ∏è</span>
    <span class="scenery-label" onclick="visitLoc('arena')">Arena</span>
  </div>

  <!-- Sun -->

  <div style="position:absolute;top:5%;right:8%;font-size:2.5em;z-index:5">‚òÄÔ∏è</div>

  <!-- Dragon -->

  <div id="dragon-wrap">
    <span id="dragon-sprite">üêâ</span>
    <div id="dragon-shadow"></div>
  </div>

  <!-- Mode badge -->

  <div id="mode-badge">üö∂ Walking</div>

  <!-- HUD -->

  <div id="hud">
    <div class="hud-card">
      <div class="hud-name" id="hud-name">Dragon</div>
      <div style="font-size:0.68em;color:#aad4ff" id="hud-type"></div>
    </div>
    <div class="hud-card">
      <div class="stat-row"><span class="stat-label">üçñ Food</span><div class="stat-bar"><div class="stat-fill fill-food" id="bar-food" style="width:70%"></div></div></div>
      <div class="stat-row"><span class="stat-label">üíß Water</span><div class="stat-bar"><div class="stat-fill fill-water" id="bar-water" style="width:70%"></div></div></div>
      <div class="stat-row"><span class="stat-label">üòÑ Happy</span><div class="stat-bar"><div class="stat-fill fill-happy" id="bar-happy" style="width:70%"></div></div></div>
      <div class="stat-row"><span class="stat-label">ü™ô Coins</span><div class="stat-bar"><div class="stat-fill fill-coins" id="bar-coins" style="width:0%"></div></div><span id="coin-count" style="font-size:0.68em;color:#ffd700;margin-left:4px">0</span></div>
    </div>
  </div>

  <!-- Controls: d-pad + mode buttons -->

  <div id="controls">
    <!-- D-PAD left -->
    <div id="dpad">
      <div></div>
      <div class="dpad-btn" id="btn-up"    onpointerdown="dpad('up',true)"    onpointerup="dpad('up',false)"    onpointerleave="dpad('up',false)">‚ñ≤</div>
      <div></div>
      <div class="dpad-btn" id="btn-left"  onpointerdown="dpad('left',true)"  onpointerup="dpad('left',false)"  onpointerleave="dpad('left',false)">‚óÑ</div>
      <div class="dpad-center"></div>
      <div class="dpad-btn" id="btn-right" onpointerdown="dpad('right',true)" onpointerup="dpad('right',false)" onpointerleave="dpad('right',false)">‚ñ∫</div>
      <div></div>
      <div class="dpad-btn" id="btn-down"  onpointerdown="dpad('down',true)"  onpointerup="dpad('down',false)"  onpointerleave="dpad('down',false)">‚ñº</div>
      <div></div>
    </div>

```
<!-- Mode buttons right -->
<div id="mode-btns">
  <button class="mode-btn active-mode" id="btn-walk" onclick="setMode('walk')">üö∂ Walk</button>
  <button class="mode-btn" id="btn-run"  onclick="setMode('run')">üí® Run</button>
  <button class="mode-btn" id="btn-fly"  onclick="setMode('fly')">ü¶Ö Fly</button>
</div>
```

  </div>

  <!-- Action bar -->

  <div id="action-bar">
    <button class="abtn btn-quest"  onclick="doAction('quest')">üó∫Ô∏è Quest</button>
    <button class="abtn btn-rescue" onclick="doAction('rescue')">üÜò Rescue</button>
    <button class="abtn btn-battle" onclick="doAction('battle')">‚öîÔ∏è Battle</button>
    <button class="abtn btn-game"   onclick="openGameMenu()">üéÆ Games</button>
    <button class="abtn btn-shop"   onclick="openShop()">üõí Shop</button>
  </div>
</div>

<!-- POPUP -->

<div class="popup-overlay" id="popup">
  <div class="popup">
    <div class="popup-title" id="popup-title"></div>
    <div id="popup-body"></div>
    <button class="close-btn" onclick="closePopup()">Close ‚úï</button>
  </div>
</div>

<script>
// ========== STATE ==========
var d = {name:'Toothless', type:'Night Fury', emoji:'üêâ', nickname:'', color:'Midnight Black', power:'Plasma Blast'};
var stats = {food:70, water:70, happy:70};
var coins = 0;
var MAX_COINS = 100;
var ownedSaddles = [];

var saddles = [
  {id:'basic',  emoji:'üü§', name:'Basic Saddle',  price:5,  desc:'A sturdy saddle for new riders!'},
  {id:'royal',  emoji:'üëë', name:'Royal Saddle',  price:15, desc:'Fit for a Viking champion!'},
  {id:'fire',   emoji:'üî•', name:'Fire Saddle',   price:20, desc:'Heat-resistant and blazing fast!'},
  {id:'shadow', emoji:'üåë', name:'Shadow Saddle', price:25, desc:'Blends into the night!'},
  {id:'ice',    emoji:'‚ùÑÔ∏è', name:'Ice Saddle',    price:30, desc:'Cool and sleek!'},
  {id:'golden', emoji:'‚ú®', name:'Golden Saddle', price:40, desc:'The rarest saddle in Berk!'}
];

// ========== MOVEMENT ==========
var drX = 150;   // dragon x position (px from left)
var drY = 0;     // dragon y offset from ground (0 = on ground)
var velY = 0;    // vertical velocity (for flying)
var facing = 1;  // 1 = right, -1 = left
var mode = 'walk'; // walk | run | fly
var SPEED = {walk:2, run:5, fly:4};
var keys = {up:false, down:false, left:false, right:false};
var groundY = 0; // calculated in init

var drWrap = null;
var drSprite = null;
var drShadow = null;
var animFrame = 0;
var gameLoop = null;

function setMode(m) {
  mode = m;
  document.querySelectorAll('.mode-btn').forEach(function(b){ b.classList.remove('active-mode'); });
  document.getElementById('btn-'+m).classList.add('active-mode');

  var badge = document.getElementById('mode-badge');
  if(m==='walk') { badge.textContent='üö∂ Walking'; badge.style.borderColor='rgba(39,174,96,0.7)'; }
  if(m==='run')  { badge.textContent='üí® Running!'; badge.style.borderColor='rgba(230,126,34,0.7)'; }
  if(m==='fly')  { badge.textContent='ü¶Ö Flying!'; badge.style.borderColor='rgba(41,128,185,0.7)'; }

  // Sky changes when flying
  var sky = document.getElementById('sky');
  if(m==='fly') sky.style.background='linear-gradient(180deg,#1a4a7a 0%,#3a9bd5 60%,#87CEEB 100%)';
  else sky.style.background='linear-gradient(180deg,#3a9bd5 0%,#87CEEB 70%,#b8e0f7 100%)';

  // If switching away from fly, bring dragon back to ground
  if(m!=='fly') { velY=0; }
}

function dpad(dir, pressed) {
  keys[dir] = pressed;
  var el = document.getElementById('btn-'+dir);
  if(el) { if(pressed) el.classList.add('pressed'); else el.classList.remove('pressed'); }
}

function tick() {
  var w = window.innerWidth;
  var h = window.innerHeight;
  groundY = h * 0.50; // y position of ground surface

  var speed = SPEED[mode];
  var moved = false;

  if(keys.left)  { drX -= speed; facing = -1; moved = true; }
  if(keys.right) { drX += speed; facing = 1;  moved = true; }

  if(mode === 'fly') {
    if(keys.up)   { velY -= 0.5; }
    if(keys.down) { velY += 0.5; }
    velY *= 0.92; // damping
    drY -= velY;
    // clamp: can't fly below ground or too high
    var maxHeight = h * 0.55;
    if(drY < 0) { drY = 0; velY = 0; }
    if(drY > maxHeight) { drY = maxHeight; velY = 0; }
  } else {
    // on ground: up/down don't apply, bounce Y to 0
    drY = 0;
  }

  // Clamp X
  if(drX < 10) drX = 10;
  if(drX > w - 80) drX = w - 80;

  // Position dragon
  var bottomPx = (h * 0.48) + drY; // distance from top
  var topPx = h - bottomPx - 70;    // convert to top offset
  drWrap.style.left = drX + 'px';
  drWrap.style.top  = topPx + 'px';

  // Flip sprite
  drSprite.style.transform = 'scaleX(' + facing + ')';

  // Bounce animation while moving
  animFrame++;
  if(moved && mode !== 'fly') {
    var bounce = Math.sin(animFrame * 0.4) * 4;
    drSprite.style.marginBottom = bounce + 'px';
  } else {
    drSprite.style.marginBottom = '0px';
  }

  // Shadow: shrinks as dragon flies higher
  var shadowScale = Math.max(0.1, 1 - drY / 300);
  var shadowOpacity = Math.max(0.05, 0.25 * shadowScale);
  drShadow.style.transform = 'scaleX(' + shadowScale + ')';
  drShadow.style.opacity = shadowOpacity;

  // Flying bob
  if(mode === 'fly' && !keys.up && !keys.down) {
    var flyBob = Math.sin(animFrame * 0.06) * 5;
    drSprite.style.marginTop = flyBob + 'px';
  } else {
    drSprite.style.marginTop = '0px';
  }

  // Coin proximity check
  checkCoinProximity();

  gameLoop = requestAnimationFrame(tick);
}

function checkCoinProximity() {
  var coins_el = document.querySelectorAll('.floating-coin');
  for(var i=0;i<coins_el.length;i++){
    var c = coins_el[i];
    var cr = c.getBoundingClientRect();
    var cx = cr.left + cr.width/2;
    var cy = cr.top + cr.height/2;
    var dr = drWrap.getBoundingClientRect();
    var dx = cx - (dr.left + dr.width/2);
    var dy = cy - (dr.top + dr.height/2);
    var dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < 55) collectCoin(c);
  }
}

// ========== SETUP ==========
function go(id) {
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}
function pick(el, name, type, emoji) {
  document.querySelectorAll('.dragon-card').forEach(function(c){c.classList.remove('selected');});
  el.classList.add('selected');
  d.name=name; d.type=type; d.emoji=emoji;
}
function pickColor(el, color) {
  document.querySelectorAll('.cbtn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected'); d.color=color;
}
function pickPower(el, power) {
  document.querySelectorAll('.pbtn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected'); d.power=power;
}
function getN() { return d.nickname || d.name; }

function startWorld() {
  d.nickname = document.getElementById('nickname').value || d.name;
  document.getElementById('hud-name').textContent = d.nickname;
  document.getElementById('hud-type').textContent = d.color + ' ' + d.type;

  drWrap = document.getElementById('dragon-wrap');
  drSprite = document.getElementById('dragon-sprite');
  drShadow = document.getElementById('dragon-shadow');
  drSprite.textContent = d.emoji;

  // Start in middle-left
  drX = window.innerWidth * 0.2;
  drY = 0;

  go('s-world');
  spawnCoins();
  setInterval(spawnCoins, 12000);
  setInterval(function(){ changeStat('food',-1); changeStat('water',-1); }, 15000);

  // Start game loop
  if(gameLoop) cancelAnimationFrame(gameLoop);
  tick();
}

// ========== STATS ==========
function changeStat(stat, amount) {
  stats[stat] = Math.max(0, Math.min(100, stats[stat] + amount));
  document.getElementById('bar-'+stat).style.width = stats[stat]+'%';
  if(stat==='food'||stat==='water'){
    stats.happy = Math.max(0,Math.min(100,(stats.food+stats.water)/2));
    document.getElementById('bar-happy').style.width = stats.happy+'%';
  }
}

// ========== COINS ==========
function spawnCoins() {
  document.querySelectorAll('.floating-coin').forEach(function(c){c.remove();});
  var sky = document.getElementById('s-world');
  for(var i=0;i<8;i++){
    var coin = document.createElement('div');
    coin.className='floating-coin';
    coin.textContent='ü™ô';
    var left = 5 + Math.random()*88;
    var top  = 15 + Math.random()*55;
    coin.style.cssText='left:'+left+'%;top:'+top+'%;animation-delay:'+(Math.random()*2)+'s;position:absolute;z-index:15;';
    sky.appendChild(coin);
  }
}

function collectCoin(el) {
  el.remove();
  if(coins >= MAX_COINS) return;
  coins++;
  updateCoins();
  var flash = document.createElement('div');
  flash.className='coin-flash';
  flash.textContent='+1 ü™ô';
  document.body.appendChild(flash);
  setTimeout(function(){ flash.remove(); },1000);
}

function updateCoins() {
  document.getElementById('bar-coins').style.width=(coins/MAX_COINS*100)+'%';
  document.getElementById('coin-count').textContent=coins;
}

// ========== FEED / WATER ==========
function feedDragon() {
  if(stats.food>=100){ showPopup('üêü Already Full!',getN()+' is stuffed! Come back when they are hungry again.',''); return; }
  changeStat('food',25);
  showPopup('üêü Fish Stand!','You grabbed a big bucket of fresh fish! '+getN()+' gobbled them up and roared happily!','<div class="outcome win">+25 Food!</div>');
}
function waterDragon() {
  if(stats.water>=100){ showPopup('üíß Not Thirsty!',getN()+' just had a big drink!',''); return; }
  changeStat('water',25);
  showPopup('üíß Watering Hole!',getN()+' took a long refreshing drink from the sparkling watering hole!','<div class="outcome win">+25 Water!</div>');
}

// ========== LOCATIONS ==========
var locData = {
  village:{t:'üèòÔ∏è The Village!', txt:'You soar over Berk! Vikings wave from below and kids cheer as your dragon swoops overhead!'},
  arena:  {t:'‚öîÔ∏è The Arena!',   txt:'The training arena has wooden targets, obstacle courses and rings of fire everywhere! Your dragon crouches and roars, ready to train!'}
};
function visitLoc(key) {
  var l=locData[key];
  showPopup(l.t,l.txt,'');
}

// ========== ADVENTURES ==========
var quests = [
  {t:'üó∫Ô∏è The Lost Map',       txt:'A mysterious map appeared showing a hidden island full of treasure! Fly through a fierce storm to reach it!'},
  {t:'üèîÔ∏è The Frozen Mountain',txt:'Villagers are trapped on the mountain in a blizzard! Dodge falling rocks to guide them home.'},
  {t:'ü•ö The Stolen Egg',     txt:'Thieves stole a rare dragon egg! Chase them across three islands and outsmart their traps!'}
];
var rescues = [
  {t:'ü¶á Trapped in a Cave!', txt:'A young Gronckle is stuck in a collapsing cave! Carry it out before the entrance seals!'},
  {t:'üï∏Ô∏è Caught in a Net!',  txt:'A Deadly Nadder is tangled in a giant fishing net! Carefully burn through the ropes!'},
  {t:'üê£ Lost Hatchlings!',   txt:'Three baby dragons wandered away! Find them all before nightfall!'}
];
var battles = [
  {t:'üî¥ The Red Death!',     txt:'A massive Red Death appeared off the coast! Dodge its fire blasts and find its weak spot!'},
  {t:'üèÜ Rival Rider!',       txt:'A rival Viking clan challenged you to a dragon battle in the arena! Prove you are the best!'},
  {t:'üåô Night Wing Attack!', txt:'A pack of Night Wings is swooping toward Berk! Lead them away!'}
];
var flyTricks = [
  {t:'üåÄ The Spiral Dive!',   txt:'You pull into a tight corkscrew spin then SNAP your wings open! The crowd goes wild!'},
  {t:'‚òÅÔ∏è The Cloud Surf!',    txt:'You glide across a fluffy cloud, dipping one wing in and out of the mist!'},
  {t:'üî• The Fire Trail!',    txt:'You blast your power in a huge arc while doing a figure-eight! Incredible!'}
];
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function doAction(type) {
  var item;
  if(type==='quest') item=rand(quests);
  else if(type==='rescue') item=rand(rescues);
  else item=rand(battles);
  var win=Math.random()>0.35;
  var msgs={
    quest: {w:'üéâ You and '+getN()+' completed the quest! Berk celebrates!', l:'üò¨ Tricky this time! '+getN()+' will try again!'},
    rescue:{w:'ü•≥ You saved the dragon! It nuzzles you in thanks!',           l:'üò∞ Hard rescue but '+getN()+' kept you safe!'},
    battle:{w:'üèÜ Victory! You showed everyone what dragon riders can do!',   l:'üí™ Tough fight! You learned new moves!'}
  };
  if(win){ changeStat('happy',10); coins=Math.min(MAX_COINS,coins+2); updateCoins(); }
  showPopup(item.t,item.txt,'<div class="outcome '+(win?'win':'lose')+'">'+(win?msgs[type].w:msgs[type].l)+'</div>');
}

// ========== SHOP ==========
function openShop() {
  var html='<div class="coin-disp">You have '+coins+' ü™ô coins</div><div class="shop-grid">';
  for(var i=0;i<saddles.length;i++){
    var s=saddles[i];
    var owned=ownedSaddles.indexOf(s.id)!==-1;
    html+='<div class="shop-item'+(owned?' owned':'')+'"'+(owned?'':' onclick="buySaddle(\''+s.id+'\',\''+s.name+'\','+s.price+')"')+'>';
    html+='<div class="s-emoji">'+s.emoji+'</div>';
    html+='<div class="s-name">'+s.name+'</div>';
    html+='<div class="s-price">'+(owned?'<span class="owned-tag">‚úÖ Owned!</span>':'ü™ô '+s.price+' coins')+'</div>';
    html+='<div style="font-size:0.7em;color:#aad4ff;margin-top:2px">'+s.desc+'</div>';
    html+='</div>';
  }
  html+='</div>';
  showPopup('üî® Blacksmith Shop','',html);
}
function buySaddle(id,name,price){
  if(coins<price){
    var f=document.createElement('div'); f.className='coin-flash'; f.style.color='#e74c3c'; f.textContent='Not enough coins!';
    document.body.appendChild(f); setTimeout(function(){f.remove();},1200); return;
  }
  coins-=price; ownedSaddles.push(id); updateCoins();
  showPopup('üéâ New Saddle!','You bought the '+name+'! '+getN()+' looks amazing in it!','<div class="outcome win">Purchase complete! üõí</div>');
}

// ========== GAMES ==========
function openGameMenu(){
  showPopup('üéÆ Play a Game!','Which game do you want to play?',
    '<div class="game-choice">'+
    '<button class="gcbtn" onclick="startTTT()">‚≠ï Tic Tac Toe</button>'+
    '<button class="gcbtn" onclick="startCards()">üÉè Card Match</button>'+
    '<button class="gcbtn" onclick="startSoccer()">‚öΩ Dragon Soccer</button>'+
    '</div>');
}

// TTT
var tttB,tttTurn,tttOn;
function startTTT(){tttB=Array(9).fill('');tttTurn='X';tttOn=true;drawTTT();}
function drawTTT(){
  var cells='';
  for(var i=0;i<9;i++) cells+='<div class="ttt-cell" onclick="tttClick('+i+')">'+(tttB[i]==='X'?'üî•':tttB[i]==='O'?d.emoji:'')+'</div>';
  document.getElementById('popup-body').innerHTML=
    '<p style="color:#aad4ff;margin-bottom:6px">'+(tttOn?(tttTurn==='X'?'Your turn üî•':getN()+'\'s turn'):'Game Over!')+'</p>'+
    '<div class="ttt-board">'+cells+'</div>'+
    '<button class="gcbtn" style="margin-top:9px" onclick="startTTT()">New Game</button>'+
    '<button class="gcbtn" style="margin-top:9px" onclick="openGameMenu()">Back</button>';
}
function tttClick(i){
  if(!tttOn||tttB[i]) return;
  tttB[i]=tttTurn;
  var w=checkTTT();
  if(w){tttOn=false;drawTTT();addTTTR(w);return;}
  if(tttB.indexOf('')===-1){tttOn=false;drawTTT();addTTTR('draw');return;}
  tttTurn=tttTurn==='X'?'O':'X'; drawTTT();
  if(tttTurn==='O') setTimeout(aiTTT,600);
}
function aiTTT(){
  if(!tttOn) return;
  var empty=[];for(var i=0;i<9;i++){if(!tttB[i])empty.push(i);}
  if(!empty.length) return;
  tttB[empty[Math.floor(Math.random()*empty.length)]]='O';
  var w=checkTTT();
  if(w){tttOn=false;drawTTT();addTTTR(w);return;}
  if(tttB.indexOf('')===-1){tttOn=false;drawTTT();addTTTR('draw');return;}
  tttTurn='X';drawTTT();
}
function checkTTT(){
  var L=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(var i=0;i<L.length;i++){var a=L[i][0],b=L[i][1],c=L[i][2];if(tttB[a]&&tttB[a]===tttB[b]&&tttB[a]===tttB[c])return tttB[a];}
  return null;
}
function addTTTR(w){
  var msg=w==='draw'?'Draw! '+getN()+' roars respectfully!':w==='X'?'üéâ You win! '+getN()+' flips happily!':getN()+' wins! üî•';
  document.getElementById('popup-body').innerHTML+='<div class="outcome '+(w==='X'?'win':w==='draw'?'':'lose')+'" style="margin-top:7px">'+msg+'</div>';
}

// CARDS
var cC,cF,cM,cCF;
var cSym=['üêâ','‚ö°','üî•','‚ùÑÔ∏è','üí®','‚ú®'];
function startCards(){
  var deck=cSym.concat(cSym).sort(function(){return Math.random()-0.5;});
  cC=deck.map(function(s,i){return{id:i,s:s,shown:false,matched:false};});
  cF=[];cM=0;cCF=true;drawCards();
}
function drawCards(){
  var html='<p style="color:#aad4ff;margin-bottom:7px">Match all pairs! '+cM+'/'+cSym.length+' matched</p><div class="card-area">';
  for(var i=0;i<cC.length;i++){var c=cC[i];html+='<div class="card'+(c.shown||c.matched?' flipped':'')+'" onclick="flipCard('+i+')">'+(c.shown||c.matched?c.s:'üê≤')+'</div>';}
  html+='</div><button class="gcbtn" style="margin-top:9px" onclick="startCards()">New Game</button><button class="gcbtn" style="margin-top:9px" onclick="openGameMenu()">Back</button>';
  document.getElementById('popup-body').innerHTML=html;
}
function flipCard(i){
  if(!cCF||cC[i].shown||cC[i].matched) return;
  cC[i].shown=true;cF.push(i);drawCards();
  if(cF.length===2){
    cCF=false;
    setTimeout(function(){
      var a=cF[0],b=cF[1];
      if(cC[a].s===cC[b].s){cC[a].matched=cC[b].matched=true;cM++;}
      cC[a].shown=cC[b].shown=false;cF=[];cCF=true;drawCards();
      if(cM===cSym.length) document.getElementById('popup-body').innerHTML+='<div class="outcome win" style="margin-top:7px">üéâ You matched them all! '+getN()+' is so proud!</div>';
    },800);
  }
}

// SOCCER
var sScore,sGoals,sOn;
function startSoccer(){sScore=0;sGoals=0;sOn=true;drawSoccer('');}
function drawSoccer(msg){
  document.getElementById('popup-body').innerHTML=
    '<p style="color:#ffd700;margin-bottom:5px">‚öΩ Dragon Soccer! Score 3 goals to win!</p>'+
    '<p style="color:#aad4ff;font-size:0.82em;margin-bottom:7px">Shots: '+sScore+' | Goals: '+sGoals+'/3</p>'+
    '<div class="goal-box"><div id="gfb" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.8em"></div></div>'+
    '<div class="aim-row">'+
    '<button class="aim-btn" onclick="shoot(\'left\')">‚ÜñÔ∏è Left</button>'+
    '<button class="aim-btn" onclick="shoot(\'center\')">‚¨ÜÔ∏è Center</button>'+
    '<button class="aim-btn" onclick="shoot(\'right\')">‚ÜóÔ∏è Right</button>'+
    '</div>'+
    (msg?'<p style="margin-top:7px;font-weight:bold;color:'+(msg.indexOf('GOAL')!==-1?'#2ecc71':'#e74c3c')+'">'+msg+'</p>':'')+
    '<button class="gcbtn" style="margin-top:9px" onclick="startSoccer()">New Game</button>'+
    '<button class="gcbtn" style="margin-top:9px" onclick="openGameMenu()">Back</button>';
}
function shoot(dir){
  if(!sOn) return;
  sScore++;
  var dirs=['left','center','right'];
  var goalie=dirs[Math.floor(Math.random()*3)];
  var scored=dir!==goalie;
  if(scored) sGoals++;
  var fb=document.getElementById('gfb');
  if(fb) fb.textContent=scored?'‚öΩ':'üß§';
  if(sGoals>=3){
    sOn=false;
    document.getElementById('popup-body').innerHTML=
      '<div class="outcome win" style="font-size:1.05em;margin:10px 0">üèÜ You scored 3 goals in '+sScore+' shots!<br>'+getN()+' does a victory lap around the arena!</div>'+
      '<button class="gcbtn" onclick="startSoccer()">Play Again</button>'+
      '<button class="gcbtn" onclick="openGameMenu()">Back</button>';
    return;
  }
  drawSoccer(scored?'GOAL! '+getN()+' breathes fire! üî•':'Saved! Try again!');
}

// ========== POPUP ==========
function showPopup(title,text,extra){
  document.getElementById('popup-title').textContent=title;
  document.getElementById('popup-body').innerHTML=(text?'<div class="popup-text">'+text+'</div>':'')+(extra||'');
  document.getElementById('popup').classList.add('open');
}
function closePopup(){
  document.getElementById('popup').classList.remove('open');
}

// ========== KEYBOARD SUPPORT ==========
document.addEventListener('keydown',function(e){
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=true;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=true;
  if(e.key==='ArrowUp'||e.key==='w') keys.up=true;
  if(e.key==='ArrowDown'||e.key==='s') keys.down=true;
  if(e.key==='1') setMode('walk');
  if(e.key==='2') setMode('run');
  if(e.key==='3') setMode('fly');
});
document.addEventListener('keyup',function(e){
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=false;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=false;
  if(e.key==='ArrowUp'||e.key==='w') keys.up=false;
  if(e.key==='ArrowDown'||e.key==='s') keys.down=false;
});
</script>

</body>
</html>
